<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Attendance Dashboard - GIET University</title>
    <meta name="description" content="Professional AI-powered attendance management system dashboard for GIET University faculty.">
    <meta name="theme-color" content="#667eea">
    
    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- CSS Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    
    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --danger-gradient: linear-gradient(135deg, #ff6b6b 0%, #ffa726 100%);
            --warning-gradient: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            --dark-gradient: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            
            --glass-background: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.18);
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --bg-light: #f7fafc;
            --shadow-light: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-heavy: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --border-radius: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-light);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: var(--dark-gradient);
            color: white;
            z-index: 1000;
            transition: var(--transition);
            overflow-y: auto;
            box-shadow: var(--shadow-medium);
        }

        .sidebar-header {
            padding: 2rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .sidebar-header .logo {
            width: 60px;
            height: 60px;
            background: var(--secondary-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.5rem;
            box-shadow: var(--shadow-light);
        }

        .sidebar-header h4 {
            margin: 0;
            font-weight: 700;
            font-size: 1.25rem;
            background: linear-gradient(135deg, #ffffff 0%, #e2e8f0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .sidebar-header p {
            margin: 0.25rem 0 0;
            font-size: 0.85rem;
            opacity: 0.7;
        }

        .user-profile {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: var(--transition);
            cursor: pointer;
        }

        .user-profile:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            background: var(--secondary-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.2rem;
            flex-shrink: 0;
            overflow: hidden;
            position: relative;
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .user-info h6 {
            margin: 0;
            font-weight: 600;
            font-size: 1rem;
        }

        .user-info p {
            margin: 0;
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .nav-section {
            padding: 1rem 0;
        }

        .nav-section-title {
            padding: 0.5rem 1.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.6;
            margin-bottom: 0.5rem;
        }

        .nav-item {
            margin: 0.25rem 1rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            border-radius: var(--border-radius);
            transition: var(--transition);
            font-weight: 500;
            gap: 0.75rem;
        }

        .nav-link:hover, .nav-link.active {
            color: white;
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(4px);
        }

        .nav-link i {
            font-size: 1.1rem;
            width: 20px;
            text-align: center;
        }

        .sidebar-stats {
            padding: 1.5rem;
            margin-top: auto;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .quick-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            font-size: 0.9rem;
        }

        .quick-stat-value {
            font-weight: 600;
            color: var(--secondary-gradient);
        }

        /* Main Content */
        .main-content {
            margin-left: 280px;
            min-height: 100vh;
            padding: 2rem;
            transition: var(--transition);
        }

        .main-header {
            background: var(--primary-gradient);
            padding: 2rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
            color: white;
            box-shadow: var(--shadow-medium);
            position: relative;
            overflow: hidden;
        }

        .main-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 50%);
            animation: float 20s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: rotate(0deg) translate(0, 0); }
            50% { transform: rotate(180deg) translate(-20px, -20px); }
        }

        .header-content {
            position: relative;
            z-index: 2;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-title h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 800;
            font-family: 'Poppins', sans-serif;
        }

        .header-title p {
            margin: 0.5rem 0 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn-header {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            font-weight: 500;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }

        .btn-header:hover {
            background: rgba(255, 255, 255, 0.3);
            color: white;
            transform: translateY(-2px);
        }

        /* Section Selection */
        .section-selection {
            background: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            margin-bottom: 2rem;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .section-selection h5 {
            margin: 0 0 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .section-radio {
            display: none;
        }

        .section-label {
            display: flex;
            align-items: center;
            padding: 1rem;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            gap: 0.75rem;
        }

        .section-radio:checked + .section-label {
            background: var(--primary-gradient);
            color: white;
            border-color: transparent;
            box-shadow: var(--shadow-medium);
        }

        .section-label:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-light);
        }

        .section-info {
            flex: 1;
        }

        .section-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .section-details {
            font-size: 0.85rem;
            opacity: 0.8;
        }
        
        .section-stats {
            margin-top: 0.75rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .section-stats .badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-weight: 500;
        }
        
        .badge-primary {
            background-color: #667eea;
            color: white;
        }
        
        .badge-success {
            background-color: #38ef7d;
            color: #2d5016;
        }
        
        .badge-danger {
            background-color: #ff6b6b;
            color: white;
        }
        
        .badge-info {
            background-color: #4facfe;
            color: white;
        }
        
        /* Newly present student animation */
        .newly-present {
            animation: highlightPresent 2s ease-in-out;
            background-color: #d4edda !important;
        }
        
        @keyframes highlightPresent {
            0% {
                background-color: #28a745;
                transform: scale(1.02);
            }
            50% {
                background-color: #20c997;
                box-shadow: 0 0 20px rgba(40, 167, 69, 0.5);
            }
            100% {
                background-color: #d4edda;
                transform: scale(1);
                box-shadow: none;
            }
        }
        
        /* Subject-wise Attendance Table */
        .attendance-subject-table {
            font-size: 0.85rem;
            min-width: 800px;
        }
        
        .attendance-subject-table th {
            text-align: center;
            padding: 8px 6px;
            font-weight: 600;
            border: 1px solid #dee2e6;
        }
        
        .attendance-subject-table td {
            text-align: center;
            padding: 6px 4px;
            border: 1px solid #dee2e6;
            vertical-align: middle;
        }
        
        .sticky-left {
            position: sticky;
            left: 0;
            background: #343a40;
            color: white;
            z-index: 10;
            min-width: 100px;
        }
        
        .total-col {
            background: #495057;
            color: white;
            min-width: 60px;
        }
        
        /* Attendance Status Colors */
        .att-present {
            background-color: #d4edda;
            color: #155724;
            font-weight: 600;
        }
        
        .att-absent {
            background-color: #f8d7da;
            color: #721c24;
            font-weight: 600;
        }
        
        .att-nc {
            background-color: #e2e3e5;
            color: #6c757d;
            font-style: italic;
        }
        
        /* Manual Attendance Toggle Buttons */
        .status-toggle-btn {
            border: 2px solid #dee2e6;
            background: #f8f9fa;
            color: #6c757d;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .status-toggle-btn.present {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }
        
        .status-toggle-btn.absent {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }
        
        .status-toggle-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* Control Panel */
        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .control-card {
            background: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: var(--transition);
        }

        .control-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-medium);
        }

        .control-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .control-title {
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .control-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .btn-control {
            padding: 0.75rem 2rem;
            border-radius: 50px;
            font-weight: 600;
            border: none;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .btn-control::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn-control:hover::before {
            left: 100%;
        }

        .btn-start {
            background: var(--success-gradient);
            color: white;
        }

        .btn-stop {
            background: var(--danger-gradient);
            color: white;
        }

        .btn-control:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-medium);
        }

        /* Camera Feed */
        .camera-section {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .camera-container {
            background: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .camera-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .camera-title {
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: #fee2e2;
            color: #dc2626;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-indicator.active {
            background: #dcfce7;
            color: #16a34a;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .camera-feed {
            width: 100%;
            height: 400px;
            background: #1a202c;
            border-radius: var(--border-radius);
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .camera-feed img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-placeholder {
            text-align: center;
            color: #64748b;
        }

        .camera-placeholder i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .camera-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat-item {
            text-align: center;
            padding: 1rem;
            background: #f8fafc;
            border-radius: var(--border-radius);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Present Students */
        .present-students {
            background: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            border: 1px solid rgba(0, 0, 0, 0.05);
            max-height: 500px;
            overflow-y: auto;
        }

        .present-students h5 {
            margin: 0 0 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .student-count {
            background: var(--success-gradient);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .student-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 1rem;
        }

        .student-item {
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            padding: 0.5rem;
            border-radius: var(--border-radius);
        }

        .student-item:hover {
            background: #f8fafc;
            transform: translateY(-2px);
        }

        .student-photo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--secondary-gradient);
            margin: 0 auto 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            border: 3px solid #e2e8f0;
            overflow: hidden;
            position: relative;
        }

        .student-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }

        .student-name {
            font-size: 0.75rem;
            font-weight: 500;
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-primary);
        }

        .student-roll {
            font-size: 0.65rem;
            color: var(--text-secondary);
            margin: 0;
        }

        /* Attendance Summary */
        .attendance-summary {
            background: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            border: 1px solid rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
        }

        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .summary-title {
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: var(--transition);
        }

        .summary-card::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
            border-radius: var(--border-radius);
            z-index: -1;
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .summary-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-medium);
        }

        .summary-card.present {
            background: var(--success-gradient);
        }

        .summary-card.absent {
            background: var(--danger-gradient);
        }

        .summary-card.total {
            background: var(--secondary-gradient);
        }

        .summary-number {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            font-family: 'Poppins', sans-serif;
        }

        .summary-label {
            font-size: 0.9rem;
            opacity: 0.9;
            font-weight: 500;
        }

        .chart-container {
            background: #f8fafc;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            height: 300px;
        }

        /* Attendance Table */
        .attendance-table-section {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            border: 1px solid rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .table-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8fafc;
        }

        .table-title {
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .table-actions {
            display: flex;
            gap: 1rem;
        }

        .btn-table {
            padding: 0.5rem 1rem;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: var(--border-radius);
            color: var(--text-primary);
            font-weight: 500;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-table:hover {
            background: var(--primary-gradient);
            color: white;
            border-color: transparent;
        }

        .table-container {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }

        .attendance-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .attendance-table th {
            background: #f8fafc;
            padding: 1rem;
            font-weight: 600;
            text-align: left;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .attendance-table td {
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: middle;
        }

        .attendance-table tbody tr {
            transition: var(--transition);
        }

        .attendance-table tbody tr:hover {
            background: #f8fafc;
        }

        .table-student-photo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--secondary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            border: 2px solid #e2e8f0;
            overflow: hidden;
            position: relative;
        }

        .table-student-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
        }

        .attendance-badge {
            padding: 0.35rem 0.75rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .badge-present {
            background: #dcfce7;
            color: #16a34a;
        }

        .badge-absent {
            background: #fee2e2;
            color: #dc2626;
        }

        .table-action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .btn-action {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f1f5f9;
            color: #64748b;
            transition: var(--transition);
            cursor: pointer;
        }

        .btn-action:hover {
            background: var(--primary-gradient);
            color: white;
        }

        /* Manual Attendance */
        .manual-attendance {
            background: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            border: 1px solid rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
        }
        
        /* Attendance Stats Summary */
        .attendance-stats-summary {
            margin-bottom: 1.5rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 1.25rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 1rem;
            height: 100%;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }
        
        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        
        .stat-content {
            flex-grow: 1;
        }
        
        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: 0.25rem;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: #64748b;
            font-weight: 500;
        }
        
        .total-students .stat-icon {
            background-color: #e0f2fe;
            color: #0ea5e9;
        }
        
        .present-students .stat-icon {
            background-color: #dcfce7;
            color: #16a34a;
        }
        
        .absent-students .stat-icon {
            background-color: #fee2e2;
            color: #dc2626;
        }
        
        .attendance-rate .stat-icon {
            background-color: #f1f5f9;
            color: #64748b;
        }
        
        /* Tab Styling */
        #attendanceEntryTabs .nav-link {
            color: #64748b;
            font-weight: 600;
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 0;
            border-bottom: 3px solid transparent;
        }
        
        #attendanceEntryTabs .nav-link.active {
            color: #3b82f6;
            background: transparent;
            border-bottom: 3px solid #3b82f6;
        }
        
        #attendanceEntryTabs .nav-link:hover:not(.active) {
            border-bottom: 3px solid #e2e8f0;
        }

        .manual-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .manual-title {
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: var(--border-radius);
            background: #f8fafc;
            transition: var(--transition);
            font-weight: 500;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: white;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background: var(--success-gradient);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Export Section */
        .export-section {
            background: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            border: 1px solid rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
        }

        .export-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .export-title {
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .export-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .export-card {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            border: 2px solid #e2e8f0;
            transition: var(--transition);
            cursor: pointer;
            text-align: center;
        }

        .export-card:hover {
            border-color: #667eea;
            background: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-light);
        }

        .export-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: #667eea;
        }

        .export-name {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .export-description {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin: 0;
        }

        /* Modals */
        .modal-content {
            border-radius: var(--border-radius);
            border: none;
            box-shadow: var(--shadow-heavy);
            overflow: hidden;
        }

        .modal-header {
            background: var(--primary-gradient);
            color: white;
            border-bottom: none;
            padding: 1.5rem;
        }

        .modal-title {
            font-weight: 700;
            font-size: 1.25rem;
        }

        .btn-close {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            opacity: 1;
        }

        .modal-body {
            padding: 2rem;
        }

        .modal-footer {
            border-top: 1px solid #e2e8f0;
            padding: 1rem 2rem;
            background: #f8fafc;
        }

        .btn-modal {
            padding: 0.75rem 2rem;
            border-radius: 50px;
            font-weight: 600;
            transition: var(--transition);
        }

        .btn-primary {
            background: var(--primary-gradient);
            border: none;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        /* Student Profile Modal */
        .student-profile-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .profile-photo {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: var(--secondary-gradient);
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: 700;
            color: white;
            border: 4px solid #e2e8f0;
            overflow: hidden;
            position: relative;
        }

        .profile-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
        }

        .profile-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .profile-roll {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .profile-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .detail-card {
            background: #f8fafc;
            padding: 1rem;
            border-radius: var(--border-radius);
            text-align: center;
        }

        .detail-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .detail-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .nav-tabs {
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 1.5rem;
        }

        .nav-tabs .nav-link {
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            font-weight: 600;
            padding: 1rem 1.5rem;
        }

        .nav-tabs .nav-link.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            min-height: 300px;
        }

        .attendance-history-table {
            width: 100%;
            border-collapse: collapse;
        }

        .attendance-history-table th,
        .attendance-history-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .attendance-history-table th {
            background: #f8fafc;
            font-weight: 600;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 1rem;
            }
            
            .camera-section {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .header-title h1 {
                font-size: 2rem;
            }
            
            .section-options {
                grid-template-columns: 1fr;
            }
            
            .control-panel {
                grid-template-columns: 1fr;
            }
            
            .summary-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .summary-stats {
                grid-template-columns: 1fr;
            }
            
            .export-options {
                grid-template-columns: 1fr;
            }
            
            .student-grid {
                grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            }
        }

        /* Loading States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Utility Classes */
        .text-gradient {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .glass {
            background: var(--glass-background);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-slide-up {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        /* Student Report Card Styles */
        .student-report-card {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 0;
        }
        
        .report-header-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 3rem 2rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
            box-shadow: var(--shadow-heavy);
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 2rem;
            align-items: center;
            position: relative;
            overflow: hidden;
        }
        
        .report-header-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 50%);
            animation: float 20s ease-in-out infinite;
        }
        
        .student-photo-section {
            position: relative;
            z-index: 2;
        }
        
        .student-photo-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid rgba(255, 255, 255, 0.3);
            box-shadow: var(--shadow-medium);
            position: relative;
        }
        
        .student-photo-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .photo-placeholder {
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
        }
        
        .student-info-section {
            position: relative;
            z-index: 2;
        }
        
        .student-name {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            font-family: 'Poppins', sans-serif;
        }
        
        .student-roll, .student-email, .student-mobile {
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
            opacity: 0.9;
        }
        
        .university-info {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .university-info h4 {
            font-size: 1.3rem;
            margin-bottom: 0.25rem;
            font-weight: 600;
        }
        
        .university-info p {
            opacity: 0.8;
            margin: 0;
        }
        
        .report-stats-section {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            position: relative;
            z-index: 2;
        }
        
        .report-stats-section .stat-item {
            text-align: center;
            background: rgba(255, 255, 255, 0.15);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .report-stats-section .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            font-family: 'Poppins', sans-serif;
        }
        
        .report-stats-section .stat-label {
            font-size: 1rem;
            opacity: 0.9;
            font-weight: 500;
        }
        
        .report-section {
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
            box-shadow: var(--shadow-light);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .report-section-header {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f1f5f9;
        }
        
        .report-section-header h3 {
            margin: 0;
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .sgpa-chart-container, .attendance-chart-container {
            background: #f8fafc;
            border-radius: var(--border-radius);
            padding: 1.5rem;
        }
        
        .semester-grades {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .grade-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #f8fafc;
            border-radius: var(--border-radius);
            border-left: 4px solid #667eea;
        }
        
        .grade-semester {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .grade-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: #667eea;
        }
        
        .attendance-summary-cards {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .attendance-summary-cards .summary-card {
            padding: 1.5rem;
            text-align: center;
            border-radius: var(--border-radius);
        }
        
        .attendance-history-table-container {
            background: #f8fafc;
            border-radius: var(--border-radius);
            padding: 1rem;
        }
        
        .attendance-history-table {
            margin: 0;
        }
        
        .attendance-history-table th {
            background: #e2e8f0;
            font-weight: 600;
            border: none;
            padding: 1rem;
            color: var(--text-primary);
        }
        
        .attendance-history-table td {
            border: none;
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .status-excellent {
            background: #dcfce7;
            color: #16a34a;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status-good {
            background: #dbeafe;
            color: #2563eb;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status-average {
            background: #fef3c7;
            color: #d97706;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status-poor {
            background: #fee2e2;
            color: #dc2626;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .report-actions {
            text-align: center;
            padding: 2rem;
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .report-actions .btn {
            padding: 1rem 2rem;
            border-radius: 50px;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .report-actions .btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-medium);
        }
        
        /* Print Styles */
        @media print {
            .sidebar, .header-actions, .report-actions {
                display: none !important;
            }
            
            .main-content {
                margin-left: 0 !important;
            }
            
            .student-report-card {
                box-shadow: none;
            }
            
            .report-section {
                break-inside: avoid;
                margin-bottom: 1rem;
            }
        }
        
        /* Responsive Design for Report Card */
        @media (max-width: 1024px) {
            .report-header-card {
                grid-template-columns: 1fr;
                text-align: center;
                gap: 1.5rem;
            }
            
            .report-stats-section {
                flex-direction: row;
                justify-content: center;
            }
        }
        
        @media (max-width: 768px) {
            .student-report-card {
                padding: 1rem 0;
            }
            
            .report-header-card {
                padding: 2rem 1rem;
            }
            
            .student-name {
                font-size: 2rem;
            }
            
            .report-section {
                padding: 1.5rem;
            }
            
            .report-actions {
                flex-direction: column;
            }
            
            .report-actions .btn {
                width: 100%;
                justify-content: center;
            }
        }
        
        /* Status Toggle Button Styles */
        .status-toggle-btn {
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            min-width: 100px;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .status-toggle-btn.present {
            background-color: #28a745;
            color: white;
        }
        
        .status-toggle-btn.present:hover {
            background-color: #218838;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }
        
        .status-toggle-btn.absent {
            background-color: #dc3545;
            color: white;
        }
        
        .status-toggle-btn.absent:hover {
            background-color: #c82333;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        }
        
        /* Attendance Summary in Modal */
        .attendance-summary {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .attendance-summary .badge {
            padding: 8px 12px;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        /* Manual attendance table styling */
        #manualAttendanceBody tr:hover {
            background-color: #f8f9fa;
        }
        
        #manualAttendanceBody td {
            vertical-align: middle;
        }
        
        /* Subject-wise Attendance Table Styles */
        .attendance-subject-table {
            font-size: 0.85rem;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .attendance-subject-table .sticky-left {
            position: sticky;
            left: 0;
            background-color: #343a40;
            z-index: 10;
            min-width: 100px;
        }
        
        .attendance-subject-table .subject-col {
            min-width: 80px;
            text-align: center;
        }
        
        .attendance-subject-table .total-col {
            background-color: #495057;
            min-width: 80px;
            text-align: center;
        }
        
        .attendance-subject-table .percentage-col {
            background-color: #6c757d;
            min-width: 100px;
            text-align: center;
            font-weight: bold;
        }
        
        .attendance-subject-table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .attendance-subject-table tbody .sticky-left {
            background-color: #e9ecef;
            font-weight: 600;
        }
        
        .attendance-subject-table tbody tr:nth-child(even) .sticky-left {
            background-color: #dee2e6;
        }
        
        .attendance-status {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            text-align: center;
            line-height: 20px;
            font-weight: bold;
            font-size: 0.75rem;
        }
        
        .attendance-status.present {
            background-color: #28a745;
            color: white;
        }
        
        .attendance-status.absent {
            background-color: #dc3545;
            color: white;
        }
        
        .attendance-detailed-view {
            max-height: 500px;
            overflow: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        
        /* Recent entry highlighting */
        .attendance-subject-table tbody tr.table-info {
            background-color: #e7f3ff;
            border-left: 4px solid #007bff;
        }
        
        .attendance-subject-table tbody tr.table-info .sticky-left {
            background-color: #d1ecf1;
        }
        
        /* Summary row styling */
        .attendance-subject-table tbody tr.table-success,
        .attendance-subject-table tbody tr.table-warning,
        .attendance-subject-table tbody tr.table-danger {
            border-top: 2px solid #6c757d;
        }
        
        /* Enhanced sticky column for summary */
        .attendance-subject-table tbody tr.table-success .sticky-left {
            background-color: #d4edda;
        }
        
        .attendance-subject-table tbody tr.table-warning .sticky-left {
            background-color: #fff3cd;
        }
        
        .attendance-subject-table tbody tr.table-danger .sticky-left {
            background-color: #f8d7da;
        }
        
        /* Hover effects for attendance history rows */
        .attendance-subject-table tbody tr:hover {
            background-color: #f8f9fa;
            transform: scale(1.01);
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .attendance-subject-table tbody tr:hover .sticky-left {
            background-color: #e2e6ea;
        }
        
        /* Enhanced Attendance Table Styling */
        .attendance-table {
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .attendance-table thead th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
            padding: 1rem 0.75rem;
            border: none;
            position: relative;
        }
        
        .attendance-table thead th::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: rgba(255, 255, 255, 0.2);
        }
        
        .attendance-row {
            transition: all 0.3s ease;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
        }
        
        .attendance-row:hover {
            background-color: #f8fafc;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .attendance-row.row-present {
            border-left: 4px solid #10b981;
            background-color: rgba(16, 185, 129, 0.02);
        }
        
        .attendance-row.row-absent {
            border-left: 4px solid #ef4444;
            background-color: rgba(239, 68, 68, 0.02);
        }
        
        .attendance-row td {
            padding: 1rem 0.75rem;
            vertical-align: middle;
            border: none;
        }
        
        .row-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 50%;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .student-info {
            display: flex;
            flex-direction: column;
        }
        
        .student-id {
            font-weight: 600;
            font-size: 0.95rem;
            color: #1e293b;
            margin-bottom: 2px;
        }
        
        .student-section {
            font-size: 0.75rem;
            color: #64748b !important;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .student-name {
            font-weight: 500;
            color: #374151;
            font-size: 0.9rem;
        }
        
        .student-mobile {
            display: flex;
            align-items: center;
            font-size: 0.85rem;
            color: #6b7280;
        }
        
        .attendance-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }
        
        .attendance-status-badge.status-present {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
        }
        
        .attendance-status-badge.status-absent {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
        }
        
        .action-buttons {
            display: flex;
            gap: 6px;
            justify-content: center;
        }
        
        .action-btn {
            padding: 6px 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
            border-width: 1.5px;
        }
        
        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        /* Loading and Empty State Improvements */
        .loading-placeholder {
            padding: 3rem 1rem;
        }
        
        .empty-state {
            padding: 2rem 1rem;
        }
        
        .empty-state i {
            opacity: 0.5;
        }
        
        /* Table Container Enhancements */
        .table-container-wrapper {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }
        
        .table-container {
            max-height: 500px;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
        }
        
        .attendance-table {
            margin-bottom: 0;
        }
        
        .attendance-table thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        
        /* Attendance Footer */
        .attendance-footer {
            background: #f8fafc;
            border-top: 2px solid #e2e8f0;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .attendance-stats {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 100px;
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: #64748b;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        
        .stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1e293b;
        }
        
        .stat-item.present .stat-value {
            color: #059669;
        }
        
        .stat-item.absent .stat-value {
            color: #dc2626;
        }
        
        .stat-item.percentage .stat-value {
            color: #7c3aed;
        }
        
        .attendance-actions {
            display: flex;
            gap: 0.75rem;
        }
        
        .attendance-actions .btn {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .attendance-actions .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        #submitAttendanceBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* Responsive Design for Attendance Footer */
        @media (max-width: 768px) {
            .attendance-footer {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
            }
            
            .attendance-stats {
                justify-content: center;
            }
            
            .attendance-actions {
                justify-content: center;
            }
        }
        
        /* Content Section Management */
        .content-section {
            display: none;
        }
        
        .content-section.active {
            display: block;
        }
        
        .section-header {
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .section-header h3 {
            color: #1e293b;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        /* Dashboard Overview Cards */
        .dashboard-overview {
            margin-top: 2rem;
        }
        
        .overview-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .overview-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        
        .overview-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .overview-card .card-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 1.5rem;
        }
        
        .overview-card.present .card-icon {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .overview-card.absent .card-icon {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .overview-card.percentage .card-icon {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }
        
        .overview-card .card-content h3 {
            font-size: 2rem;
            font-weight: 800;
            margin: 0;
            color: #1e293b;
        }
        
        .overview-card .card-content p {
            margin: 0;
            color: #64748b;
            font-weight: 500;
        }
        
        /* Attendance Summary Section */
        .attendance-summary-section {
            margin: 2rem 0;
            padding: 1.5rem;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }
        
        .summary-header {
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .summary-header h5 {
            color: #1e293b;
            font-weight: 600;
            margin: 0;
        }
        
        .attendance-progress-bars {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .progress-item {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .progress-item.total {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border-color: #0ea5e9;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .progress-label {
            font-weight: 600;
            color: #374151;
        }
        
        .progress-percentage {
            font-weight: 700;
            color: #1e293b;
        }
        
        .progress-bar-container {
            width: 100%;
            height: 12px;
            background-color: #e5e7eb;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            border-radius: 6px;
            transition: width 0.6s ease;
            position: relative;
        }
        
        .progress-bar.theory {
            background: linear-gradient(90deg, #10b981, #059669);
        }
        
        .progress-bar.lab {
            background: linear-gradient(90deg, #3b82f6, #2563eb);
        }
        
        .progress-bar.total {
            background: linear-gradient(90deg, #8b5cf6, #7c3aed);
        }
        
        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 40%, rgba(255,255,255,0.3) 50%, transparent 60%);
            background-size: 20px 20px;
            animation: progress-shine 2s infinite;
        }
        
        @keyframes progress-shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .attendance-status {
            text-align: center;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .attendance-status i {
            font-size: 1.25rem;
        }
        
        .status-text {
            font-weight: 600;
            color: #059669;
        }
        
        /* Manual Options Cards */
        .manual-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
        }
        
        .option-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        
        .option-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
            border-color: #667eea;
        }
        
        .option-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        
        .option-content h5 {
            margin: 0 0 0.5rem 0;
            color: #1e293b;
            font-weight: 600;
        }
        
        .option-content p {
            margin: 0;
            color: #64748b;
            font-size: 0.9rem;
        }
        
        /* Professional Enhancements */
        .main-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
        }
        
        .main-header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin: 0;
        }
        
        .main-header p {
            font-size: 1.1rem;
            margin: 0.5rem 0 0 0;
            opacity: 0.9;
        }
        
        .btn-header {
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-header:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-1px);
        }
        
        /* Section Transitions */
        .content-section {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.4s ease;
        }
        
        .content-section.active {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Responsive Improvements */
        @media (max-width: 768px) {
            .main-header h1 {
                font-size: 2rem;
            }
            
            .manual-options {
                grid-template-columns: 1fr;
            }
            
            .option-card {
                padding: 1.5rem;
                text-align: center;
                flex-direction: column;
            }
        }
        
        /* Student Photo in Attendance Table */
        .student-photo-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 50px;
            height: 50px;
            margin: 0 auto;
        }
        
        .student-photo {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        
        .student-photo:hover {
            transform: scale(1.1);
            border-color: #667eea;
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }
        
        .photo-placeholder {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.85rem;
            border: 2px solid #e2e8f0;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <i class="bi bi-mortarboard"></i>
            </div>
            <h4>AI Attendance</h4>
            <p>GIET University</p>
        </div>

        <div class="user-profile" onclick="showTeacherProfile()">
            <div class="user-avatar">
                {{ faculty_name[0].upper() if faculty_name else 'F' }}
            </div>
            <div class="user-info">
                <h6>{{ faculty_name or 'Faculty' }}</h6>
                <p>{{ username or 'faculty' }}</p>
            </div>
        </div>

        <nav class="nav-section">
            <div class="nav-section-title">Main</div>
            <div class="nav-item">
                <a href="#" class="nav-link active" onclick="showSection('dashboard')">
                    <i class="bi bi-grid-1x2"></i>
                    Dashboard
                </a>
            </div>
            <div class="nav-item">
                <a href="#" class="nav-link" onclick="showSection('attendance')">
                    <i class="bi bi-person-check"></i>
                    Attendance
                </a>
            </div>
            <div class="nav-item">
                <a href="#" class="nav-link" onclick="showSection('manual')">
                    <i class="bi bi-pencil-square"></i>
                    Manual Entry
                </a>
            </div>
            <div class="nav-item">
                <a href="/online_attendance" class="nav-link">
                    <i class="bi bi-laptop"></i>
                    Online Classes
                </a>
            </div>
            <div class="nav-item">
                <a href="#" class="nav-link" onclick="showSection('reports')">
                    <i class="bi bi-bar-chart"></i>
                    Reports
                </a>
            </div>
        </nav>

        <nav class="nav-section">
            <div class="nav-section-title">Tools</div>
            <div class="nav-item">
                <a href="#" class="nav-link" onclick="exportToExcel()">
                    <i class="bi bi-file-earmark-excel"></i>
                    Export Excel
                </a>
            </div>
            <div class="nav-item">
                <a href="#" class="nav-link" onclick="exportToCSV()">
                    <i class="bi bi-file-earmark-text"></i>
                    Export CSV
                </a>
            </div>
            <div class="nav-item">
                <a href="#" class="nav-link" onclick="openEmailModal()">
                    <i class="bi bi-envelope"></i>
                    Send Reports
                </a>
            </div>
        </nav>

        <nav class="nav-section">
            <div class="nav-section-title">Account</div>
            <div class="nav-item">
                <a href="/logout" class="nav-link">
                    <i class="bi bi-box-arrow-right"></i>
                    Logout
                </a>
            </div>
        </nav>

        <div class="sidebar-stats">
            <div class="quick-stat">
                <span>Today's Classes</span>
                <span class="quick-stat-value" id="todayClasses">0</span>
            </div>
            <div class="quick-stat">
                <span>Present Students</span>
                <span class="quick-stat-value" id="presentCount">0</span>
            </div>
            <div class="quick-stat">
                <span>Attendance Rate</span>
                <span class="quick-stat-value" id="attendanceRate">0%</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Mobile Menu Button -->
        <button class="btn btn-primary d-lg-none mb-3" onclick="toggleSidebar()">
            <i class="bi bi-list"></i> Menu
        </button>

        <!-- Header -->
        <div class="main-header animate-fade-in">
            <div class="header-content">
                <div class="header-title">
                    <h1 id="dynamicGreeting">Good Morning!</h1>
                    <p>Manage your classes with AI-powered attendance tracking</p>
                </div>
                <div class="header-actions">
                    <button class="btn-header" onclick="refreshData()">
                        <i class="bi bi-arrow-clockwise"></i>
                        Refresh
                    </button>
                    <button class="btn-header" onclick="showHelp()">
                        <i class="bi bi-question-circle"></i>
                        Help
                    </button>
                </div>
            </div>
        </div>

        <!-- Dashboard Content Sections -->
        <div id="dashboardSection" class="content-section active animate-fade-in">
            <!-- Section Selection -->
            <div class="section-selection">
                <h5>
                    <i class="bi bi-people"></i>
                    Select Class Section
                </h5>
                <div class="section-options" id="sectionOptions">
                    <!-- Sections will be dynamically loaded here -->
                </div>
            </div>
            
            <!-- Quick Stats Overview -->
            <div class="dashboard-overview" id="dashboardOverview" style="display: none;">
                <div class="overview-cards">
                    <div class="overview-card">
                        <div class="card-icon">
                            <i class="bi bi-people-fill"></i>
                        </div>
                        <div class="card-content">
                            <h3 id="overviewTotal">0</h3>
                            <p>Total Students</p>
                        </div>
                    </div>
                    <div class="overview-card present">
                        <div class="card-icon">
                            <i class="bi bi-check-circle-fill"></i>
                        </div>
                        <div class="card-content">
                            <h3 id="overviewPresent">0</h3>
                            <p>Present Today</p>
                        </div>
                    </div>
                    <div class="overview-card absent">
                        <div class="card-icon">
                            <i class="bi bi-x-circle-fill"></i>
                        </div>
                        <div class="card-content">
                            <h3 id="overviewAbsent">0</h3>
                            <p>Absent Today</p>
                        </div>
                    </div>
                    <div class="overview-card percentage">
                        <div class="card-icon">
                            <i class="bi bi-graph-up"></i>
                        </div>
                        <div class="card-content">
                            <h3 id="overviewPercentage">0%</h3>
                            <p>Attendance Rate</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="attendanceSection" class="content-section animate-fade-in" style="display: none;">
            <div class="section-header">
                <h3><i class="bi bi-person-check"></i> Live Attendance Tracking</h3>
                <p class="text-muted">Monitor real-time attendance using face recognition technology</p>
            </div>
            
            <!-- This will be populated by JavaScript when section is loaded -->
            <div id="attendanceContent"></div>
        </div>
        
        <div id="manualSection" class="content-section animate-fade-in" style="display: none;">
            <div class="section-header">
                <h3><i class="bi bi-pencil-square"></i> Manual Attendance Entry</h3>
                <p class="text-muted">Manually mark attendance for individual students or entire class</p>
            </div>
            
            <div class="manual-options">
                <div class="option-card" onclick="openManualAttendanceModal()">
                    <div class="option-icon">
                        <i class="bi bi-list-check"></i>
                    </div>
                    <div class="option-content">
                        <h5>Bulk Attendance Entry</h5>
                        <p>Mark attendance for multiple students at once</p>
                    </div>
                </div>
                
                <div class="option-card" onclick="showNotification('Individual entry via student table', 'info')">
                    <div class="option-icon">
                        <i class="bi bi-person-plus"></i>
                    </div>
                    <div class="option-content">
                        <h5>Individual Entry</h5>
                        <p>Mark attendance for individual students</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="reportsSection" class="content-section animate-fade-in" style="display: none;">
            <div class="section-header">
                <h3><i class="bi bi-bar-chart"></i> Reports & Analytics</h3>
                <p class="text-muted">Generate detailed attendance reports and view analytics</p>
            </div>
            
            <div id="reportsContent">
                <!-- Reports content will be moved here by JavaScript -->
            </div>
        </div>

        <!-- Control Panel -->
        <div class="control-panel animate-fade-in">
            <div class="control-card">
                <div class="control-header">
                    <h5 class="control-title">
                        <i class="bi bi-camera-video"></i>
                        Attendance Session
                    </h5>
                    <div class="status-indicator" id="sessionStatus">
                        <div class="status-dot"></div>
                        Inactive
                    </div>
                </div>
                <div class="control-actions">
                    <button class="btn-control btn-start" id="startButton" onclick="startAttendance()">
                        <i class="bi bi-play-fill"></i>
                        Start Session
                    </button>
                    <button class="btn-control btn-stop" id="stopButton" onclick="stopAttendance()" disabled>
                        <i class="bi bi-stop-fill"></i>
                        Stop Session
                    </button>
                </div>
            </div>

            <div class="control-card">
                <div class="control-header">
                    <h5 class="control-title">
                        <i class="bi bi-graph-up"></i>
                        Quick Stats
                    </h5>
                </div>
                <div class="summary-stats">
                    <div class="summary-card total">
                        <div class="summary-number" id="totalStudents">0</div>
                        <div class="summary-label">Total Students</div>
                    </div>
                    <div class="summary-card present">
                        <div class="summary-number" id="presentStudents">0</div>
                        <div class="summary-label">Present</div>
                    </div>
                    <div class="summary-card absent">
                        <div class="summary-number" id="absentStudents">0</div>
                        <div class="summary-label">Absent</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Camera and Present Students Section -->
        <div class="camera-section animate-fade-in">
            <div class="camera-container">
                <div class="camera-header">
                    <h5 class="camera-title">
                        <i class="bi bi-camera"></i>
                        Live Camera Feed
                    </h5>
                    <div class="status-indicator" id="cameraStatus">
                        <div class="status-dot"></div>
                        Disconnected
                    </div>
                </div>
                <div class="camera-feed" id="cameraFeed">
                    <div class="camera-placeholder">
                        <i class="bi bi-camera-video-off"></i>
                        <p>Camera feed will appear here</p>
                        <small>Start an attendance session to begin</small>
                    </div>
                </div>
                <div class="camera-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="fpsCount">
                            <i class="bi bi-speedometer2 me-2"></i>0
                        </div>
                        <div class="stat-label">FPS</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="facesDetected">
                            <i class="bi bi-person-bounding-box me-2"></i>0
                        </div>
                        <div class="stat-label">Faces</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="recognitionRate">
                            <i class="bi bi-eye me-2"></i>0%
                        </div>
                        <div class="stat-label">Recognition</div>
                    </div>
                </div>
            </div>

            <div class="present-students">
                <h5>
                    <span>
                        <i class="bi bi-person-check"></i>
                        Present Students
                    </span>
                    <span class="student-count" id="presentCountBadge">0</span>
                </h5>
                <div class="student-grid" id="presentStudentsGrid">
                    <div class="text-center py-4 text-muted">
                        <i class="bi bi-person-plus" style="font-size: 2rem; opacity: 0.5;"></i>
                        <p class="mt-2 mb-0">Students will appear here once detected</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Attendance Summary -->
        <div class="attendance-summary animate-fade-in">
            <div class="summary-header">
                <h5 class="summary-title">
                    <i class="bi bi-graph-up-arrow"></i>
                     Attendance Overview & Analytics
                </h5>
                <button class="btn-table" onclick="generateReport()">
                    <i class="bi bi-file-earmark-bar-graph"></i>
                     Generate Report
                </button>
            </div>
            <div class="chart-container">
                <canvas id="attendanceChart"></canvas>
            </div>
        </div>

        <!-- Attendance Table -->
        <div class="attendance-table-section animate-fade-in">
            <div class="table-header">
                <h5 class="table-title">
                    <i class="bi bi-table"></i>
                    Student Attendance Records
                </h5>
                <div class="table-actions">
                    <button class="btn-table" onclick="refreshAttendanceTable()">
                        <i class="bi bi-arrow-clockwise"></i>
                        Refresh
                    </button>
                    <button class="btn-table" onclick="openManualAttendanceModal()">
                        <i class="bi bi-pencil"></i>
                        Manual Entry
                    </button>
                    <button class="btn-table" onclick="exportTableData()">
                        <i class="bi bi-download"></i>
                        Export
                    </button>
                </div>
            </div>
            <div class="table-container-wrapper">
                <div class="table-container">
                    <table class="attendance-table" id="attendanceTable">
                        <thead class="sticky-top">
                            <tr>
                                <th width="8%">Photo</th>
                                <th width="22%">Roll Number</th>
                                <th width="30%">Student Name</th>
                                <th width="15%">Mobile</th>
                                <th width="15%">Status</th>
                                <th width="10%">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceTableBody">
                            <tr>
                                <td colspan="6" class="text-center py-4 text-muted">
                                    <div class="loading-placeholder">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-3 mb-0 fw-medium">Loading student attendance data...</p>
                                        <small class="text-muted">Please wait while we fetch the records</small>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Attendance Summary Footer -->
                <div class="attendance-footer">
                    <div class="attendance-stats">
                        <div class="stat-item">
                            <span class="stat-label">Total Students:</span>
                            <span class="stat-value" id="totalStudentsCount">0</span>
                        </div>
                        <div class="stat-item present">
                            <span class="stat-label">Present:</span>
                            <span class="stat-value" id="presentStudentsCount">0</span>
                        </div>
                        <div class="stat-item absent">
                            <span class="stat-label">Absent:</span>
                            <span class="stat-value" id="absentStudentsCount">0</span>
                        </div>
                        <div class="stat-item percentage">
                            <span class="stat-label">Attendance Rate:</span>
                            <span class="stat-value" id="attendancePercentage">0%</span>
                        </div>
                    </div>
                    <div class="attendance-actions">
                        <button class="btn btn-success" id="submitAttendanceBtn" onclick="submitAttendance()" disabled>
                            <i class="bi bi-check-circle"></i>
                            Submit Attendance
                        </button>
                        <button class="btn btn-warning" onclick="resetAttendance()">
                            <i class="bi bi-arrow-clockwise"></i>
                            Reset
                        </button>
                    </div>
                </div>
            </div>
        </div>


        <!-- Export Section -->
        <div class="export-section animate-fade-in">
            <div class="export-header">
                <h5 class="export-title">
                    <i class="bi bi-download"></i>
                    Export & Reports
                </h5>
            </div>
            <div class="export-options">
                <div class="export-card" onclick="exportToExcel()">
                    <div class="export-icon">
                        <i class="bi bi-file-earmark-excel"></i>
                    </div>
                    <h6 class="export-name">Excel Export</h6>
                    <p class="export-description">Download attendance data in Excel format</p>
                </div>
                <div class="export-card" onclick="exportToCSV()">
                    <div class="export-icon">
                        <i class="bi bi-file-earmark-text"></i>
                    </div>
                    <h6 class="export-name">CSV Export</h6>
                    <p class="export-description">Download attendance data as CSV file</p>
                </div>
                <div class="export-card" onclick="generatePDFReport()">
                    <div class="export-icon">
                        <i class="bi bi-file-earmark-pdf"></i>
                    </div>
                    <h6 class="export-name">PDF Report</h6>
                    <p class="export-description">Generate comprehensive PDF report</p>
                </div>
                <div class="export-card" onclick="openEmailModal()">
                    <div class="export-icon">
                        <i class="bi bi-envelope"></i>
                    </div>
                    <h6 class="export-name">Email Reports</h6>
                    <p class="export-description">Send attendance reports via email</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Profile Modal -->
    <div class="modal fade" id="studentProfileModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-person-circle"></i>
                        Student Profile
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="student-profile-header">
                        <div class="profile-photo" id="profilePhoto">
                            <span id="profileInitials">S</span>
                        </div>
                        <h4 class="profile-name" id="profileName">Student Name</h4>
                        <p class="profile-roll" id="profileRoll">Roll Number</p>
                    </div>
                    
                    <div class="profile-details">
                        <div class="detail-card">
                            <div class="detail-value" id="profileCGPA">8.5</div>
                            <div class="detail-label">CGPA</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-value" id="profilePresent">45</div>
                            <div class="detail-label">Present</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-value" id="profileAbsent">8</div>
                            <div class="detail-label">Absent</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-value" id="profileTotal">53</div>
                            <div class="detail-label">Total Classes</div>
                        </div>
                    </div>
                    
                    <!-- Attendance Summary Section -->
                    <div class="attendance-summary-section">
                        <div class="summary-header">
                            <h5><i class="bi bi-bar-chart"></i> Attendance Summary</h5>
                        </div>
                        <div class="attendance-progress-bars">
                            <div class="progress-item">
                                <div class="progress-header">
                                    <span class="progress-label">Theory Attendance</span>
                                    <span class="progress-percentage" id="theoryAttendancePercent">89%</span>
                                </div>
                                <div class="progress-bar-container">
                                    <div class="progress-bar theory" id="theoryAttendanceBar" style="width: 89%;"></div>
                                </div>
                            </div>
                            
                            <div class="progress-item">
                                <div class="progress-header">
                                    <span class="progress-label">Lab Attendance</span>
                                    <span class="progress-percentage" id="labAttendancePercent">100%</span>
                                </div>
                                <div class="progress-bar-container">
                                    <div class="progress-bar lab" id="labAttendanceBar" style="width: 100%;"></div>
                                </div>
                            </div>
                            
                            <div class="progress-item total">
                                <div class="progress-header">
                                    <span class="progress-label">Total Attendance</span>
                                    <span class="progress-percentage" id="totalAttendancePercent">90%</span>
                                </div>
                                <div class="progress-bar-container">
                                    <div class="progress-bar total" id="totalAttendanceBar" style="width: 90%;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="attendance-status" id="attendanceStatus">
                            <i class="bi bi-check-circle-fill text-success"></i>
                            <span class="status-text">Very Good Attendance</span>
                        </div>
                    </div>
                    
                    <!-- Attendance Summary Section -->
                    <div class="attendance-summary-section">
                        <div class="summary-header">
                            <h5><i class="bi bi-bar-chart"></i> Attendance Summary</h5>
                        </div>
                        <div class="attendance-progress-bars">
                            <div class="progress-item">
                                <div class="progress-header">
                                    <span class="progress-label">Theory Attendance</span>
                                    <span class="progress-percentage" id="theoryAttendancePercent">89%</span>
                                </div>
                                <div class="progress-bar-container">
                                    <div class="progress-bar theory" id="theoryAttendanceBar" style="width: 89%;"></div>
                                </div>
                            </div>
                            
                            <div class="progress-item">
                                <div class="progress-header">
                                    <span class="progress-label">Lab Attendance</span>
                                    <span class="progress-percentage" id="labAttendancePercent">100%</span>
                                </div>
                                <div class="progress-bar-container">
                                    <div class="progress-bar lab" id="labAttendanceBar" style="width: 100%;"></div>
                                </div>
                            </div>
                            
                            <div class="progress-item total">
                                <div class="progress-header">
                                    <span class="progress-label">Total Attendance</span>
                                    <span class="progress-percentage" id="totalAttendancePercent">90%</span>
                                </div>
                                <div class="progress-bar-container">
                                    <div class="progress-bar total" id="totalAttendanceBar" style="width: 90%;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="attendance-status" id="attendanceStatus">
                            <i class="bi bi-check-circle-fill text-success"></i>
                            <span class="status-text">Very Good Attendance</span>
                        </div>
                    </div>

                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#attendanceTab">Attendance History</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#performanceTab">Performance</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#contactTab">Contact Info</a>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="attendanceTab">
                            <div class="table-responsive">
                                <div class="attendance-detailed-view">
                                    <table class="table table-sm table-bordered attendance-subject-table">
                                        <thead class="table-dark">
                                            <tr id="subjectHeaderRow">
                                                <th class="sticky-left">Date</th>
                                                <!-- Subject columns will be dynamically added -->
                                                <th class="total-col">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody id="attendanceHistoryBody">
                                            <!-- Subject-wise attendance will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="performanceTab">
                            <div id="sgpaChart" style="height: 300px;"></div>
                        </div>
                        <div class="tab-pane fade" id="contactTab">
                            <div class="contact-info">
                                <p><strong>Mobile:</strong> <span id="profileMobile">+91 9876543210</span></p>
                                <p><strong>Email:</strong> <span id="profileEmail">student@giet.edu</span></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="sendIndividualEmail()">
                        <i class="bi bi-envelope"></i>
                        Send Email
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Modal -->
    <div class="modal fade" id="emailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-envelope"></i>
                        Send Attendance Reports
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="emailForm">
                        <div class="form-group">
                            <label class="form-label">Email Recipients</label>
                            <textarea class="form-control" id="emailRecipients" rows="3" 
                                placeholder="Enter email addresses separated by commas"></textarea>
                            <small class="text-muted">Leave empty to send to all students</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Subject</label>
                            <input type="text" class="form-control" id="emailSubject" 
                                value="Attendance Report - {{ sections.keys()|first if sections else 'Class' }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Message</label>
                            <textarea class="form-control" id="emailMessage" rows="5">Dear Student,

Please find your attendance report attached. Make sure to maintain regular attendance to meet the minimum requirement.

Best regards,
{{ faculty_name or 'Faculty' }}
GIET University</textarea>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="attachReportCheck" checked>
                            <label class="form-check-label" for="attachReportCheck">
                                Attach attendance report
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="sendEmailReports()">
                        <i class="bi bi-send"></i>
                        Send Reports
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manual Attendance Modal -->
    <div class="modal fade" id="manualAttendanceModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-pencil-square"></i>
                        Manual Attendance Entry
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Attendance Entry Tabs -->
                    <ul class="nav nav-tabs mb-3" id="attendanceEntryTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="individual-tab" data-bs-toggle="tab" data-bs-target="#individual-entry" type="button" role="tab" aria-controls="individual-entry" aria-selected="true">
                                <i class="bi bi-person"></i> Individual Entry
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="bulk-tab" data-bs-toggle="tab" data-bs-target="#bulk-entry" type="button" role="tab" aria-controls="bulk-entry" aria-selected="false">
                                <i class="bi bi-people"></i> Bulk Entry
                            </button>
                        </li>
                    </ul>
                    
                    <!-- Attendance Stats Summary -->
                    <div class="attendance-stats-summary mb-4">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="stat-card total-students">
                                    <div class="stat-icon"><i class="bi bi-people-fill"></i></div>
                                    <div class="stat-content">
                                        <div class="stat-value" id="totalStudentsCount">60</div>
                                        <div class="stat-label">Total Students</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card present-students">
                                    <div class="stat-icon"><i class="bi bi-check-circle-fill"></i></div>
                                    <div class="stat-content">
                                        <div class="stat-value" id="presentCountModal">0</div>
                                        <div class="stat-label">Present Today</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card absent-students">
                                    <div class="stat-icon"><i class="bi bi-x-circle-fill"></i></div>
                                    <div class="stat-content">
                                        <div class="stat-value" id="absentCountModal">60</div>
                                        <div class="stat-label">Absent Today</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card attendance-rate">
                                    <div class="stat-icon"><i class="bi bi-percent"></i></div>
                                    <div class="stat-content">
                                        <div class="stat-value" id="attendanceRateModal">0%</div>
                                        <div class="stat-label">Attendance Rate</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab Content -->
                    <div class="tab-content" id="attendanceEntryTabContent">
                        <!-- Individual Entry Tab -->
                        <div class="tab-pane fade show active" id="individual-entry" role="tabpanel" aria-labelledby="individual-tab">
                            <!-- Students List -->
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th width="15%">Roll Number</th>
                                            <th width="35%">Name</th>
                                            <th width="20%">Mobile</th>
                                            <th width="30%">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="manualAttendanceBody">
                                        <!-- Manual attendance entries will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Bulk Entry Tab -->
                        <div class="tab-pane fade" id="bulk-entry" role="tabpanel" aria-labelledby="bulk-tab">
                            <!-- Mass Actions -->
                            <div class="mb-3 d-flex gap-2 justify-content-between align-items-center">
                                <div>
                                    <button type="button" class="btn btn-success" onclick="markAllPresent()">
                                        <i class="bi bi-check-all"></i>
                                        Mark All Present
                                    </button>
                                    <button type="button" class="btn btn-danger" onclick="markAllAbsent()">
                                        <i class="bi bi-x-circle"></i>
                                        Mark All Absent
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Bulk Students List -->
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th width="5%"><input type="checkbox" id="selectAllStudents" onclick="toggleAllStudents()"></th>
                                            <th width="15%">Roll Number</th>
                                            <th width="35%">Name</th>
                                            <th width="15%">Mobile</th>
                                            <th width="30%">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="bulkAttendanceBody">
                                        <!-- Bulk attendance entries will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveManualAttendance()">
                        <i class="bi bi-save"></i>
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Global Variables
        let currentSection = '';
        let attendanceChart = null;
        let isAttendanceActive = false;
        let recognitionInterval = null;
        let attendanceData = [];
        let presentStudents = new Set();
        
        // Check if user is a student (based on template variables)
        const isStudent = {% if is_student %}true{% else %}false{% endif %};
        const studentRollNumber = '{% if student_roll %}{{ student_roll }}{% else %}{% endif %}';
        const facultyName = '{% if faculty_name %}{{ faculty_name }}{% else %}Faculty{% endif %}';
        const username = '{% if username %}{{ username }}{% else %}user{% endif %}';
        
        console.log('Dashboard initialized:', {
            isStudent: isStudent,
            studentRollNumber: studentRollNumber,
            facultyName: facultyName,
            username: username
        });

        // Dynamic Greeting Function
        function updateDynamicGreeting() {
            const now = new Date();
            const hour = now.getHours();
            let greeting = '';
            let icon = '';
            
            if (hour >= 5 && hour < 12) {
                greeting = 'Good Morning';
                icon = '';
            } else if (hour >= 12 && hour < 17) {
                greeting = 'Good Afternoon';
                icon = '';
            } else if (hour >= 17 && hour < 21) {
                greeting = 'Good Evening';
                icon = '';
            } else {
                greeting = 'Good Night';
                icon = '';
            }
            
            const greetingElement = document.getElementById('dynamicGreeting');
            const facultyDisplayName = facultyName || username || 'Faculty';
            
            if (greetingElement) {
                greetingElement.innerHTML = `${icon} ${greeting}, ${facultyDisplayName}!`;
            }
        }

        // Initialize Dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Update dynamic greeting first
            updateDynamicGreeting();
            
            if (isStudent) {
                // Student Dashboard Initialization
                initializeStudentDashboard();
            } else {
                // Faculty Dashboard Initialization
                loadSections();
                initializeCharts();
                setupEventListeners();
                startPeriodicUpdates();
                
                // Check if student profile should be opened (from login redirect)
                const urlParams = new URLSearchParams(window.location.search);
                const studentRoll = urlParams.get('student');
                if (studentRoll) {
                    setTimeout(() => showStudentProfile(studentRoll), 1000);
                }
            }
        });
        
        // Student Dashboard Initialization
        function initializeStudentDashboard() {
            // Hide faculty-specific elements and show student report card
            createStudentReportCard();
            
            // Load student's data
            if (studentRollNumber) {
                loadStudentReportCardData();
            }
        }
        
        // Create Student Report Card Interface
        function createStudentReportCard() {
            // Hide all existing sections
            const mainContent = document.querySelector('.main-content');
            const existingElements = mainContent.querySelectorAll('.section-selection, .control-panel, .camera-section, .attendance-summary, .attendance-table-section, .manual-attendance, .export-section');
            
            existingElements.forEach(el => el.style.display = 'none');
            
            // Update header
            const headerTitle = document.querySelector('.header-title h1');
            const headerSubtitle = document.querySelector('.header-title p');
            
            if (headerTitle) {
                headerTitle.innerHTML = `<i class="bi bi-award"></i> Student Report Card`;
            }
            if (headerSubtitle) {
                headerSubtitle.textContent = `Academic Record for ${studentRollNumber}`;
            }
            
            // Create report card HTML
            const reportCardHTML = `
                <div class="student-report-card animate-fade-in">
                    <!-- Student Header Card -->
                    <div class="report-header-card">
                        <div class="student-photo-section">
                            <div class="student-photo-large" id="studentPhotoLarge">
                                <img src="https://gietuerp.in/StudentDocuments/${studentRollNumber}/${studentRollNumber}.JPG" 
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" 
                                     alt="${studentRollNumber}">
                                <div class="photo-placeholder" style="display: none;">
                                    <i class="bi bi-person-circle"></i>
                                </div>
                            </div>
                        </div>
                        <div class="student-info-section">
                            <h2 class="student-name" id="reportStudentName">Loading...</h2>
                            <p class="student-roll">Roll Number: <strong id="reportStudentRoll">${studentRollNumber}</strong></p>
                            <p class="student-email" id="reportStudentEmail">Email: Loading...</p>
                            <p class="student-mobile" id="reportStudentMobile">Mobile: Loading...</p>
                            <div class="university-info">
                                <h4>GIET University</h4>
                                <p>Department of Computer Science & Engineering</p>
                            </div>
                        </div>
                        <div class="report-stats-section">
                            <div class="stat-item">
                                <div class="stat-value" id="reportCGPA">0.0</div>
                                <div class="stat-label">CGPA</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="reportAttendance">0%</div>
                                <div class="stat-label">Attendance</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Academic Performance Section -->
                    <div class="report-section">
                        <div class="report-section-header">
                            <h3><i class="bi bi-graph-up"></i> Academic Performance</h3>
                        </div>
                        <div class="row">
                            <div class="col-md-8">
                                <div class="sgpa-chart-container">
                                    <div id="studentSGPAChart" style="height: 350px;"></div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="semester-grades" id="semesterGrades">
                                    <!-- SGPA grades will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Attendance Analysis Section -->
                    <div class="report-section">
                        <div class="report-section-header">
                            <h3><i class="bi bi-calendar-check"></i> Attendance Analysis</h3>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="attendance-chart-container">
                                    <canvas id="studentAttendanceChart" width="400" height="300"></canvas>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="attendance-summary-cards">
                                    <div class="summary-card present">
                                        <div class="summary-number" id="totalPresent">0</div>
                                        <div class="summary-label">Classes Attended</div>
                                    </div>
                                    <div class="summary-card absent">
                                        <div class="summary-number" id="totalAbsent">0</div>
                                        <div class="summary-label">Classes Missed</div>
                                    </div>
                                    <div class="summary-card total">
                                        <div class="summary-number" id="totalClasses">0</div>
                                        <div class="summary-label">Total Classes</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detailed Attendance Record -->
                    <div class="report-section">
                        <div class="report-section-header">
                            <h3><i class="bi bi-table"></i> Detailed Attendance Record</h3>
                        </div>
                        <div class="attendance-history-table-container">
                            <div class="table-responsive">
                                <table class="table table-striped attendance-history-table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Day</th>
                                            <th>Classes Scheduled</th>
                                            <th>Classes Attended</th>
                                            <th>Attendance Rate</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="attendanceHistoryTableBody">
                                        <!-- Attendance history will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Actions Section -->
                    <div class="report-actions">
                        <button class="btn btn-primary btn-lg" onclick="downloadReportCard()">
                            <i class="bi bi-download"></i>
                            Download Report Card
                        </button>
                        <button class="btn btn-outline-primary btn-lg" onclick="printReportCard()">
                            <i class="bi bi-printer"></i>
                            Print Report Card
                        </button>
                        <button class="btn btn-outline-success btn-lg" onclick="shareReportCard()">
                            <i class="bi bi-share"></i>
                            Share Report Card
                        </button>
                    </div>
                </div>
            `;
            
            // Insert report card after header
            const header = document.querySelector('.main-header');
            header.insertAdjacentHTML('afterend', reportCardHTML);
            
            // Update sidebar for student
            updateSidebarForStudent();
            
            // Initialize charts after DOM is ready
            setTimeout(() => {
                initializeCharts();
            }, 100);
        }
        
        // Load Student Report Card Data
        async function loadStudentReportCardData() {
            try {
                const response = await fetch(`/api/student/${studentRollNumber}`);
                const result = await response.json();
                
                if (result.success) {
                    const student = result.student;
                    populateReportCardData(student);
                }
            } catch (error) {
                console.error('Error loading student report card data:', error);
                showNotification('Error loading student data', 'error');
            }
        }
        
        // Populate Report Card with Student Data
        function populateReportCardData(student) {
            // Update basic information
            document.getElementById('reportStudentName').textContent = student.name || studentRollNumber;
            
            // Generate email in correct format: rollno.name@giet.edu (no spaces/dots in name)
            let emailName = 'student';
            if (student.name) {
                // Remove ALL non-alphabetic characters to create single word
                emailName = student.name.replace(/[^a-zA-Z]/g, '').toLowerCase();
            }
            const emailAddress = `${studentRollNumber.toLowerCase()}.${emailName}@giet.edu`;
            document.getElementById('reportStudentEmail').innerHTML = `Email: <strong>${emailAddress}</strong>`;
            document.getElementById('reportStudentMobile').innerHTML = `Mobile: <strong>${student.mobile || 'N/A'}</strong>`;
            
            // Update stats
            document.getElementById('reportCGPA').textContent = student.cgpa || 'N/A';
            document.getElementById('reportAttendance').textContent = (student.attendance_percentage || 0) + '%';
            
            // Populate SGPA grades
            populateSemesterGrades(student.sgpas || {});
            
            // Create SGPA chart
            if (student.sgpas) {
                createStudentSGPAChart(student.sgpas);
            }
            
            // Populate attendance data
            populateAttendanceData(student);
            
            // Create attendance chart
            createStudentAttendanceChart(student);
        }
        
        // Populate Semester Grades
        function populateSemesterGrades(sgpas) {
            const gradesContainer = document.getElementById('semesterGrades');
            gradesContainer.innerHTML = '<h4 class="mb-3">Semester-wise SGPA</h4>';
            
            Object.keys(sgpas).sort().forEach(semester => {
                const sgpa = parseFloat(sgpas[semester]) || 0;
                const gradeClass = sgpa >= 9 ? 'text-success' : sgpa >= 8 ? 'text-primary' : sgpa >= 7 ? 'text-warning' : 'text-danger';
                
                const gradeItem = `
                    <div class="grade-item">
                        <span class="grade-semester">Semester ${semester}</span>
                        <span class="grade-value ${gradeClass}">${sgpa.toFixed(2)}</span>
                    </div>
                `;
                gradesContainer.innerHTML += gradeItem;
            });
        }
        
        // Create Student SGPA Chart
        function createStudentSGPAChart(sgpas) {
            const container = document.getElementById('studentSGPAChart');
            
            if (!sgpas || Object.keys(sgpas).length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-info-circle"></i> No SGPA data available</div>';
                return;
            }
            
            const semesters = Object.keys(sgpas).sort();
            const values = semesters.map(s => parseFloat(sgpas[s]) || 0);
            
            const trace = {
                x: semesters.map(s => `Semester ${s}`),
                y: values,
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: '#667eea', width: 4 },
                marker: { 
                    color: '#667eea', 
                    size: 12,
                    line: { color: 'white', width: 2 }
                },
                fill: 'tonexty',
                fillcolor: 'rgba(102, 126, 234, 0.1)'
            };
            
            const layout = {
                title: {
                    text: 'SGPA Performance Trend',
                    font: { size: 18, family: 'Poppins', weight: 600 }
                },
                xaxis: { 
                    title: 'Semester',
                    showgrid: true,
                    gridcolor: '#f0f0f0'
                },
                yaxis: { 
                    title: 'SGPA', 
                    range: [0, 10],
                    showgrid: true,
                    gridcolor: '#f0f0f0'
                },
                margin: { l: 60, r: 40, t: 60, b: 60 },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)'
            };
            
            Plotly.newPlot(container, [trace], layout, { responsive: true });
        }
        
        // Populate Attendance Data
        function populateAttendanceData(student) {
            const dailyAttendance = student.daily_attendance || [];
            
            let totalClasses = 0;
            let attendedClasses = 0;
            
            dailyAttendance.forEach(day => {
                totalClasses += day.total_classes;
                attendedClasses += day.classes_attended;
            });
            
            const missedClasses = totalClasses - attendedClasses;
            
            // Update summary cards
            document.getElementById('totalPresent').textContent = attendedClasses;
            document.getElementById('totalAbsent').textContent = missedClasses;
            document.getElementById('totalClasses').textContent = totalClasses;
            
            // Populate attendance history table
            populateAttendanceHistory(dailyAttendance);
        }
        
        // Create Student Attendance Chart
        function createStudentAttendanceChart(student) {
            const ctx = document.getElementById('studentAttendanceChart');
            if (!ctx) return;
            
            const dailyAttendance = student.daily_attendance || [];
            let totalClasses = 0;
            let attendedClasses = 0;
            
            dailyAttendance.forEach(day => {
                totalClasses += day.total_classes;
                attendedClasses += day.classes_attended;
            });
            
            const missedClasses = totalClasses - attendedClasses;
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Classes Attended', 'Classes Missed'],
                    datasets: [{
                        data: [attendedClasses, missedClasses],
                        backgroundColor: ['#10b981', '#ef4444'],
                        borderWidth: 0,
                        cutout: '70%'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 14,
                                    weight: '500'
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Populate Attendance History Table
        function populateAttendanceHistory(dailyAttendance) {
            const tbody = document.getElementById('attendanceHistoryTableBody');
            
            if (!dailyAttendance || dailyAttendance.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No attendance history available</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            
            // Sort by date (most recent first)
            dailyAttendance.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            dailyAttendance.slice(0, 20).forEach(day => { // Show last 20 records
                const attendanceRate = day.total_classes > 0 ? (day.classes_attended / day.total_classes) * 100 : 0;
                const statusClass = attendanceRate >= 90 ? 'status-excellent' : 
                                   attendanceRate >= 75 ? 'status-good' : 
                                   attendanceRate >= 60 ? 'status-average' : 'status-poor';
                const statusText = attendanceRate >= 90 ? 'Excellent' : 
                                  attendanceRate >= 75 ? 'Good' : 
                                  attendanceRate >= 60 ? 'Average' : 'Poor';
                
                const row = `
                    <tr>
                        <td><strong>${day.date}</strong></td>
                        <td>${day.day || 'N/A'}</td>
                        <td class="text-center">${day.total_classes}</td>
                        <td class="text-center">${day.classes_attended}</td>
                        <td class="text-center"><strong>${attendanceRate.toFixed(1)}%</strong></td>
                        <td class="text-center"><span class="${statusClass}">${statusText}</span></td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            
            // Update footer stats and enable submit button
            updateAttendanceFooterStats();
            updateDashboardStats();
        }
        
        // Update Attendance Footer Stats
        function updateAttendanceFooterStats() {
            const total = window.currentSectionStudents ? window.currentSectionStudents.length : 0;
            const present = presentStudents.size;
            const absent = total - present;
            const percentage = total > 0 ? Math.round((present / total) * 100) : 0;
            
            const totalElement = document.getElementById('totalStudentsCount');
            const presentElement = document.getElementById('presentStudentsCount');
            const absentElement = document.getElementById('absentStudentsCount');
            const percentageElement = document.getElementById('attendancePercentage');
            
            if (totalElement) totalElement.textContent = total;
            if (presentElement) presentElement.textContent = present;
            if (absentElement) absentElement.textContent = absent;
            if (percentageElement) percentageElement.textContent = percentage + '%';
            
            // Enable/disable submit button
            const submitBtn = document.getElementById('submitAttendanceBtn');
            if (submitBtn) {
                submitBtn.disabled = total === 0;
            }
        }
        
        // Report Card Action Functions
        function downloadReportCard() {
            showNotification('Preparing download...', 'info');
            window.print();
        }
        
        function printReportCard() {
            window.print();
        }
        
        function shareReportCard() {
            if (navigator.share) {
                navigator.share({
                    title: `Report Card - ${studentRollNumber}`,
                    text: `Academic report card for student ${studentRollNumber}`,
                    url: window.location.href
                }).catch(err => {
                    console.log('Error sharing:', err);
                    copyReportLink();
                });
            } else {
                copyReportLink();
            }
        }
        
        function copyReportLink() {
            navigator.clipboard.writeText(window.location.href).then(() => {
                showNotification('Report card link copied to clipboard!', 'success');
            }).catch(() => {
                showNotification('Unable to copy link', 'error');
            });
        }
        
        // Hide elements that students shouldn't see
        function hideElementsForStudents() {
            // Hide section selection
            const sectionSelection = document.querySelector('.section-selection');
            if (sectionSelection) sectionSelection.style.display = 'none';
            
            // Hide control panel (attendance session controls)
            const controlPanel = document.querySelector('.control-panel');
            if (controlPanel) controlPanel.style.display = 'none';
            
            // Hide camera section
            const cameraSection = document.querySelector('.camera-section');
            if (cameraSection) cameraSection.style.display = 'none';
            
            // Hide manual attendance
            const manualAttendance = document.querySelector('.manual-attendance');
            if (manualAttendance) manualAttendance.style.display = 'none';
            
            // Hide export section
            const exportSection = document.querySelector('.export-section');
            if (exportSection) exportSection.style.display = 'none';
            
            // Hide attendance table (showing all students)
            const attendanceTableSection = document.querySelector('.attendance-table-section');
            if (attendanceTableSection) attendanceTableSection.style.display = 'none';
            
            // Update sidebar navigation for students
            updateSidebarForStudent();
        }
        
        // Update sidebar navigation for students
        function updateSidebarForStudent() {
            // Update user profile section with student image
            const userAvatar = document.querySelector('.user-avatar');
            if (userAvatar && studentRollNumber) {
                userAvatar.innerHTML = `
                    <img src="https://gietuerp.in/StudentDocuments/${studentRollNumber}/${studentRollNumber}.JPG" 
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" 
                         alt="${studentRollNumber}" 
                         style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                    <span style="display: none; font-weight: 600; font-size: 1.2rem;">${studentRollNumber.slice(-2)}</span>
                `;
            }
            
            // Update user info in sidebar
            const userInfo = document.querySelector('.user-info h6');
            const userRole = document.querySelector('.user-info p');
            if (userInfo) {
                userInfo.textContent = studentRollNumber;
            }
            if (userRole) {
                userRole.textContent = 'Student';
            }
            
            // Hide faculty-specific navigation items
            const navItems = document.querySelectorAll('.nav-section');
            navItems.forEach(section => {
                const title = section.querySelector('.nav-section-title');
                if (title && (title.textContent === 'Tools' || title.textContent === 'Main')) {
                    // Keep only dashboard link for students
                    const navLinks = section.querySelectorAll('.nav-item');
                    navLinks.forEach(item => {
                        const link = item.querySelector('.nav-link');
                        if (link && !link.textContent.includes('Dashboard')) {
                            item.style.display = 'none';
                        }
                    });
                }
            });
        }
        
        // Update header for student view
        function updateHeaderForStudent() {
            const headerTitle = document.querySelector('.header-title h1');
            const headerSubtitle = document.querySelector('.header-title p');
            
            if (headerTitle) {
                headerTitle.textContent = `Welcome, ${studentRollNumber}!`;
            }
            if (headerSubtitle) {
                headerSubtitle.textContent = 'View your attendance records and academic performance';
            }
        }
        
        // Load student-specific dashboard data
        async function loadStudentDashboardData() {
            try {
                const response = await fetch(`/api/student/${studentRollNumber}`);
                const result = await response.json();
                
                if (result.success) {
                    const student = result.student;
                    updateStudentSummaryCards(student);
                    updateStudentAttendanceChart(student);
                }
            } catch (error) {
                console.error('Error loading student data:', error);
            }
        }
        
        // Update summary cards for student
        function updateStudentSummaryCards(student) {
            // Update the summary cards with student-specific data
            document.getElementById('totalStudents').textContent = student.attendance_percentage || '0';
            document.querySelector('#totalStudents').nextElementSibling.textContent = 'Attendance %';
            
            document.getElementById('presentStudents').textContent = student.cgpa || 'N/A';
            document.querySelector('#presentStudents').nextElementSibling.textContent = 'CGPA';
            
            const totalClasses = student.daily_attendance ? student.daily_attendance.length : 0;
            document.getElementById('absentStudents').textContent = totalClasses;
            document.querySelector('#absentStudents').nextElementSibling.textContent = 'Total Classes';
        }
        
        // Update attendance chart for student
        function updateStudentAttendanceChart(student) {
            if (attendanceChart && student.daily_attendance) {
                const totalClasses = student.daily_attendance.reduce((sum, day) => sum + day.total_classes, 0);
                const attendedClasses = student.daily_attendance.reduce((sum, day) => sum + day.classes_attended, 0);
                const missedClasses = totalClasses - attendedClasses;
                
                attendanceChart.data.datasets[0].data = [attendedClasses, missedClasses];
                attendanceChart.data.labels = ['Classes Attended', 'Classes Missed'];
                attendanceChart.update();
            }
        }

        // Load Sections
        async function loadSections() {
            try {
                console.log('Loading sections...');
                const response = await fetch('/api/sections');
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const sections = await response.json();
                console.log('Sections received:', sections);
                
                // Check if sections is an array and has data
                if (!Array.isArray(sections)) {
                    throw new Error('Invalid response format - expected array');
                }
                
                if (sections.length === 0) {
                    throw new Error('No sections returned from server');
                }
                
                const container = document.getElementById('sectionOptions');
                if (!container) {
                    console.error('sectionOptions container not found');
                    return;
                }
                container.innerHTML = '';
                
                sections.forEach(section => {
                    // Calculate actual student count based on the range
                    const actualStudentCount = section.end - section.start + 1;
                    const sectionCard = `
                        <div>
                            <input type="radio" id="section-${section.id}" name="section" value="${section.id}" class="section-radio" onchange="selectSection('${section.id}')">
                            <label for="section-${section.id}" class="section-label">
                                <div class="section-info">
                                    <div class="section-name">${section.name}</div>
                                    <div class="section-details">${actualStudentCount} students  ${section.present} present  ${section.absent} absent</div>
                                    <div class="section-stats">
                                        <span class="badge badge-primary">Total: ${actualStudentCount}</span>
                                        <span class="badge badge-success">Present: ${section.present}</span>
                                        <span class="badge badge-danger">Absent: ${section.absent}</span>
                                        <span class="badge badge-info">Rate: ${section.attendance_rate}%</span>
                                    </div>
                                </div>
                            </label>
                        </div>
                    `;
                    container.innerHTML += sectionCard;
                });

                // Auto-select first section if available
                if (sections.length > 0 && !currentSection) {
                    document.getElementById(`section-${sections[0].id}`).checked = true;
                    await selectSection(sections[0].id);
                }
            } catch (error) {
                console.error('Error loading sections:', error);
                const container = document.getElementById('sectionOptions');
                if (container) {
                    if (error.message.includes('401')) {
                        container.innerHTML = `
                            <div class="text-center text-muted py-3">
                                <i class="bi bi-exclamation-triangle"></i> 
                                <p>Please log in again to access sections</p>
                                <button class="btn btn-sm btn-outline-primary" onclick="window.location.href='/login'">Login</button>
                            </div>
                        `;
                    } else {
                        container.innerHTML = `
                            <div class="text-center text-muted py-3">
                                <i class="bi bi-info-circle"></i> 
                                <p>No sections available</p>
                                <small class="text-muted">Error: ${error.message}</small>
                            </div>
                        `;
                    }
                }
            }
        }

        // Select Section
        async function selectSection(sectionId) {
            currentSection = sectionId;
            
            // Load all students for the selected section and mark them as absent by default
            await loadSectionStudents(sectionId);
            
            updateSectionData();
            loadAttendanceData();
            updateQuickStats();
        }
        
        // Load Section Students and Initialize Attendance
        async function loadSectionStudents(sectionId) {
            try {
                // Loading students silently
                
                const response = await fetch(`/api/section_students?section=${sectionId}`);
                const result = await response.json();
                
                if (result.success) {
                    // Clear current attendance
                    presentStudents.clear();
                    
                    // Initialize all students as absent (they're not in presentStudents set)
                    const studentsCount = result.students.length;
                    
                    // Update the attendance table with all students marked as absent
                    updateAttendanceTable(result.students);
                    
                    // Update stats - all students are absent initially
                    updateQuickStats(0, studentsCount);
                    
                    // Update present students display (will be empty)
                    updatePresentStudentsList([]);
                    
                    // Students loaded successfully - no need for notification
                    
                    // Store section students for reference
                    window.currentSectionStudents = result.students;
                } else {
                    showNotification(result.message || 'Failed to load section students', 'error');
                }
            } catch (error) {
                console.error('Error loading section students:', error);
                // Handle error silently
            }
        }

        // Update Section Data
        function updateSectionData() {
            // Update UI based on selected section
            updateAttendanceTable();
            refreshPresentStudents();
        }

        // Start Attendance Session
        async function startAttendance() {
            if (!currentSection) {
                showNotification('Please select a section first', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/start_attendance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        section: currentSection
                    })
                });

                const result = await response.json();

                if (result.success) {
                    isAttendanceActive = true;
                    document.getElementById('startButton').disabled = true;
                    document.getElementById('stopButton').disabled = false;
                    
                    // Update status
                    const statusIndicator = document.getElementById('sessionStatus');
                    statusIndicator.innerHTML = '<div class="status-dot"></div>Active';
                    statusIndicator.classList.add('active');
                    
                    // Start camera feed
                    startCameraFeed();
                    
                    // Start recognition updates
                    startRecognitionUpdates();
                    
                    showNotification('Attendance session started successfully', 'success');
                } else {
                    showNotification(result.message || 'Failed to start attendance session', 'error');
                }
            } catch (error) {
                console.error('Error starting attendance:', error);
                showNotification('Network error. Please try again.', 'error');
            }
        }

        // Stop Attendance Session
        async function stopAttendance(sendEmails = false) {
            try {
                const response = await fetch('/api/stop_attendance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        section: currentSection,
                        send_emails: sendEmails
                    })
                });

                const result = await response.json();

                if (result.success) {
                    isAttendanceActive = false;
                    document.getElementById('startButton').disabled = false;
                    document.getElementById('stopButton').disabled = true;
                    
                    // Update status
                    const statusIndicator = document.getElementById('sessionStatus');
                    statusIndicator.innerHTML = '<div class="status-dot"></div>Inactive';
                    statusIndicator.classList.remove('active');
                    
                    // Stop camera feed
                    stopCameraFeed();
                    
                    // Stop recognition updates
                    stopRecognitionUpdates();
                    
                    // Update attendance table
                    updateAttendanceTable();
                    
                    // Show detailed notification
                    let message = result.message || 'Attendance session stopped and data saved';
                    if (result.absent_count > 0) {
                        message += ` (${result.absent_count} absent students)`;
                    }
                    showNotification(message, 'success');
                    
                    // Ask if user wants to send emails to absent students
                    if (result.absent_count > 0 && !sendEmails) {
                        setTimeout(() => {
                            if (confirm(`${result.absent_count} students were absent. Would you like to send email notifications to them?`)) {
                                sendAbsentStudentEmails();
                            }
                        }, 1000);
                    }
                } else {
                    showNotification(result.message || 'Failed to stop attendance session', 'error');
                }
            } catch (error) {
                console.error('Error stopping attendance:', error);
                showNotification('Network error. Please try again.', 'error');
            }
        }
        
        // Send emails to absent students
        async function sendAbsentStudentEmails() {
            try {
                showNotification('Sending emails to absent students...', 'info');
                
                const response = await fetch('/api/send_attendance_emails', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        section: currentSection
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(result.message, 'success');
                } else {
                    showNotification(result.message || 'Failed to send emails', 'error');
                }
            } catch (error) {
                console.error('Error sending emails:', error);
                showNotification('Error sending emails. Please try again.', 'error');
            }
        }
        
        // Update Attendance Summary in Student Profile
        function updateAttendanceSummary(student) {
            // Calculate different types of attendance
            const overallPercentage = student.attendance_percentage || 85;
            
            // Mock data for theory and lab attendance (in real implementation, fetch from API)
            const theoryPercentage = Math.max(0, overallPercentage + Math.floor(Math.random() * 10) - 5);
            const labPercentage = Math.max(0, overallPercentage + Math.floor(Math.random() * 15) - 5);
            const totalPercentage = Math.round((theoryPercentage + labPercentage) / 2);
            
            // Update progress bars
            document.getElementById('theoryAttendancePercent').textContent = theoryPercentage + '%';
            document.getElementById('theoryAttendanceBar').style.width = theoryPercentage + '%';
            
            document.getElementById('labAttendancePercent').textContent = labPercentage + '%';
            document.getElementById('labAttendanceBar').style.width = labPercentage + '%';
            
            document.getElementById('totalAttendancePercent').textContent = totalPercentage + '%';
            document.getElementById('totalAttendanceBar').style.width = totalPercentage + '%';
            
            // Update attendance status message
            const statusElement = document.getElementById('attendanceStatus');
            const statusIcon = statusElement.querySelector('i');
            const statusText = statusElement.querySelector('.status-text');
            
            if (totalPercentage >= 90) {
                statusIcon.className = 'bi bi-check-circle-fill text-success';
                statusText.textContent = 'Excellent Attendance';
                statusText.style.color = '#059669';
            } else if (totalPercentage >= 80) {
                statusIcon.className = 'bi bi-check-circle-fill text-success';
                statusText.textContent = 'Very Good Attendance';
                statusText.style.color = '#059669';
            } else if (totalPercentage >= 75) {
                statusIcon.className = 'bi bi-exclamation-triangle-fill text-warning';
                statusText.textContent = 'Good Attendance';
                statusText.style.color = '#d97706';
            } else if (totalPercentage >= 60) {
                statusIcon.className = 'bi bi-exclamation-triangle-fill text-warning';
                statusText.textContent = 'Low Attendance - Needs Improvement';
                statusText.style.color = '#d97706';
            } else {
                statusIcon.className = 'bi bi-x-circle-fill text-danger';
                statusText.textContent = 'Critical - Attendance Too Low';
                statusText.style.color = '#dc2626';
            }
        }

        // Start Camera Feed
        function startCameraFeed() {
            const cameraFeed = document.getElementById('cameraFeed');
            cameraFeed.innerHTML = '<img src="/video_feed" alt="Camera Feed" style="width: 100%; height: 100%; object-fit: cover;">';
            
            // Update camera status
            const cameraStatus = document.getElementById('cameraStatus');
            cameraStatus.innerHTML = '<div class="status-dot"></div>Connected';
            cameraStatus.classList.add('active');
        }

        // Stop Camera Feed
        function stopCameraFeed() {
            const cameraFeed = document.getElementById('cameraFeed');
            cameraFeed.innerHTML = `
                <div class="camera-placeholder">
                    <i class="bi bi-camera-video-off"></i>
                    <p>Camera feed stopped</p>
                    <small>Start a session to begin</small>
                </div>
            `;
            
            // Update camera status
            const cameraStatus = document.getElementById('cameraStatus');
            cameraStatus.innerHTML = '<div class="status-dot"></div>Disconnected';
            cameraStatus.classList.remove('active');
            
            // Reset camera stats
            document.getElementById('fpsCount').innerHTML = '<i class="bi bi-speedometer2 me-2"></i>0';
            document.getElementById('facesDetected').innerHTML = '<i class="bi bi-person-bounding-box me-2"></i>0';
            document.getElementById('recognitionRate').innerHTML = '<i class="bi bi-eye me-2"></i>0%';
        }

        // Start Recognition Updates
        function startRecognitionUpdates() {
            recognitionInterval = setInterval(updateRecognitionStatus, 1000);
        }

        // Stop Recognition Updates
        function stopRecognitionUpdates() {
            if (recognitionInterval) {
                clearInterval(recognitionInterval);
                recognitionInterval = null;
            }
        }

        // Update Recognition Status
        async function updateRecognitionStatus() {
            if (!isAttendanceActive) return;

            try {
                const response = await fetch('/api/recognition_status');
                const status = await response.json();

                // Update camera stats
                document.getElementById('fpsCount').innerHTML = '<i class="bi bi-speedometer2 me-2"></i>' + (status.fps || 0);
                document.getElementById('facesDetected').innerHTML = '<i class="bi bi-person-bounding-box me-2"></i>' + (status.faces_detected || 0);
                document.getElementById('recognitionRate').innerHTML = '<i class="bi bi-eye me-2"></i>' + 
                    (status.faces_detected > 0 ? Math.round((status.present_count / status.faces_detected) * 100) + '%' : '0%');

                // Update present students when new students are detected
                if (status.present_students && status.present_students.length > 0) {
                    // Add newly detected students to the present set
                    status.present_students.forEach(rollNumber => {
                        const wasAlreadyPresent = presentStudents.has(rollNumber);
                        presentStudents.add(rollNumber);
                        
                        // Show notification for newly detected student
                        if (!wasAlreadyPresent && isAttendanceActive) {
                            showNotification(` ${rollNumber} detected and marked present!`, 'success');
                        }
                    });
                    
                    updatePresentStudentsList(status.present_students);
                    
                    // Update the attendance table to reflect new status
                    updateAttendanceTable();
                }

                // Update quick stats with current present count
                updateQuickStats(presentStudents.size);

            } catch (error) {
                console.error('Error updating recognition status:', error);
            }
        }

        // Update Present Students List
        function updatePresentStudentsList(students) {
            const grid = document.getElementById('presentStudentsGrid');
            const badge = document.getElementById('presentCountBadge');
            
            badge.textContent = students.length;
            
            if (students.length === 0) {
                grid.innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <i class="bi bi-person-plus" style="font-size: 2rem; opacity: 0.5;"></i>
                        <p class="mt-2 mb-0">No students detected yet</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = '';
            students.forEach(rollNumber => {
                const studentCard = createStudentCard(rollNumber);
                grid.innerHTML += studentCard;
            });
        }

        // Create Student Card
        function createStudentCard(rollNumber) {
            // Skip dropped students (identified by ERR_HTTP2_PROTOCOL_ERROR)
            if (rollNumber && rollNumber.includes('ERR_HTTP2_PROTOCOL_ERROR')) {
                console.log('Skipping dropped student card:', rollNumber);
                return ''; // Don't create card for dropped students
            }
            
            const initials = rollNumber.length >= 2 ? rollNumber.substr(-2) : rollNumber.substr(0, 2);
            const imageUrl = `https://gietuerp.in/StudentDocuments/${rollNumber}/${rollNumber}.JPG`;
            
            return `
                <div class="student-item" onclick="showStudentProfile('${rollNumber}')">
                    <div class="student-photo">
                        <img src="${imageUrl}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" alt="${rollNumber}">
                        <span style="display: none;">${initials}</span>
                    </div>
                    <p class="student-name">${rollNumber}</p>
                    <p class="student-roll">Present</p>
                </div>
            `;
        }

        // Show Student Profile
        async function showStudentProfile(rollNumber) {
            try {
                const response = await fetch(`/api/student/${rollNumber}`);
                const result = await response.json();

                if (result.success) {
                    const student = result.student;
                    
                    // Update modal content
                    document.getElementById('profileName').textContent = student.name || rollNumber;
                    document.getElementById('profileRoll').textContent = student.rollNo || rollNumber;
                    document.getElementById('profileCGPA').textContent = student.cgpa || 'N/A';
                    document.getElementById('profileMobile').textContent = student.mobile || 'N/A';
                    // Generate email in format: rollno.studentname@giet.edu (no spaces/dots in name)
                    let emailName = 'student';
                    if (student.name) {
                        // Remove ALL non-alphabetic characters to create single word
                        emailName = student.name.replace(/[^a-zA-Z]/g, '').toLowerCase();
                    }
                    const emailAddress = `${rollNumber.toLowerCase()}.${emailName}@giet.edu`;
                    document.getElementById('profileEmail').textContent = emailAddress;
                    
                    // Update photo
                    const profilePhoto = document.getElementById('profilePhoto');
                    const initials = student.name ? student.name.split(' ').map(n => n[0]).join('') : rollNumber.substr(-2);
                    const imageUrl = student.image_url || `https://gietuerp.in/StudentDocuments/${rollNumber}/${rollNumber}.JPG`;
                    
                    profilePhoto.innerHTML = `
                        <img src="${imageUrl}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" alt="${rollNumber}">
                        <span id="profileInitials" style="display: none;">${initials}</span>
                    `;
                    
                    // Update attendance history with roll number and section
                    updateAttendanceHistory(rollNumber, student.section);
                    
                    // Update attendance summary
                    updateAttendanceSummary(student);
                    
                    // Update SGPA chart
                    if (student.sgpas) {
                        updateSGPAChart(student.sgpas);
                    }
                    
                    // Show modal
                    const modal = new bootstrap.Modal(document.getElementById('studentProfileModal'));
                    modal.show();
                } else {
                    showNotification('Student data not found', 'error');
                }
            } catch (error) {
                console.error('Error loading student profile:', error);
                showNotification('Error loading student profile', 'error');
            }
        }

        // Update Attendance History with Subject-wise Data from timetable.json (Stack Format - Recent First)
        async function updateAttendanceHistory(rollNumber, studentSection = null) {
            const tbody = document.getElementById('attendanceHistoryBody');
            const headerRow = document.getElementById('subjectHeaderRow');
            
            // Clear existing content
            tbody.innerHTML = '<tr><td colspan="9" class="text-center"><div class="spinner-border spinner-border-sm"></div> Loading attendance history...</td></tr>';
            
            try {
                // Get timetable and attendance data
                const [timetableResponse, attendanceResponse] = await Promise.all([
                    fetch('/api/timetable'),
                    fetch(`/api/student_attendance/${rollNumber}`)
                ]);
                
                const timetableData = await timetableResponse.json();
                const attendanceData = await attendanceResponse.json();
                
                if (!timetableData.success || !attendanceData.success) {
                    tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Failed to load attendance history</td></tr>';
                    return;
                }
                
                const studentSectionToUse = studentSection || currentSection || 'CSE_5A'; // Use student's section if available, otherwise fallback to current section
                const timetable = timetableData.timetable[studentSectionToUse];
                const studentAttendance = attendanceData.attendance;
                
                if (!timetable) {
                    tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No timetable found for this section</td></tr>';
                    return;
                }
                
                // Extract unique subjects from timetable
                const subjects = [];
                Object.values(timetable).forEach(daySchedule => {
                    daySchedule.forEach(classInfo => {
                        if (!subjects.includes(classInfo.subject)) {
                            subjects.push(classInfo.subject);
                        }
                    });
                });
                
                // Display all subjects
                const displaySubjects = subjects;
                
                // Update header with subjects and percentage column
                headerRow.innerHTML = '<th class="sticky-left">Date</th>';
                displaySubjects.forEach(subject => {
                    const shortName = subject.length > 12 ? subject.substring(0, 10) + '..' : subject;
                    headerRow.innerHTML += `<th class="subject-col" title="${subject}">${shortName}</th>`;
                });
                headerRow.innerHTML += '<th class="total-col">Total</th>';
                headerRow.innerHTML += '<th class="percentage-col">Cumulative %</th>';
                
                // Get attendance dates (recent first - stack format)
                const attendanceDates = Object.keys(studentAttendance).sort((a, b) => new Date(b) - new Date(a)).slice(0, 15);
                
                if (attendanceDates.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No attendance records found</td></tr>';
                    return;
                }
                
                let totalPossibleClasses = 0;
                let totalAttendedClasses = 0;
                tbody.innerHTML = '';
                
                // Build rows (recent first - stack format)
                attendanceDates.forEach((dateStr, index) => {
                    const date = new Date(dateStr);
                    const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                    const daySchedule = timetable[dayName] || [];
                    
                    let dayPresentCount = 0;
                    let dayTotalClasses = 0;
                    
                    let row = `<tr class="${index === 0 ? 'table-info' : ''}" title="${dayName}, ${dateStr}">`;
                    row += `<td class="sticky-left"><strong>${dateStr}</strong><br><small class="text-muted">${dayName}</small></td>`;
                    
                    // Subject attendance columns
                    displaySubjects.forEach(subject => {
                        const hasSubjectToday = daySchedule.some(classInfo => classInfo.subject === subject);
                        
                        if (hasSubjectToday) {
                            // Check if student was present for this subject on this day
                            const isPresent = studentAttendance[dateStr] && studentAttendance[dateStr][rollNumber] === 1;
                            const statusClass = isPresent ? 'present' : 'absent';
                            const statusIcon = isPresent ? '' : '';
                            
                            if (isPresent) dayPresentCount++;
                            dayTotalClasses++;
                            
                            row += `<td class="text-center"><span class="attendance-status ${statusClass}" title="${subject}: ${isPresent ? 'Present' : 'Absent'}">${statusIcon}</span></td>`;
                        } else {
                            // No class for this subject today
                            row += `<td class="text-center"><span class="text-muted" title="No ${subject} class today">-</span></td>`;
                        }
                    });
                    
                    totalPossibleClasses += dayTotalClasses;
                    totalAttendedClasses += dayPresentCount;
                    
                    // Daily total
                    const dailyPercentage = dayTotalClasses > 0 ? Math.round((dayPresentCount / dayTotalClasses) * 100) : 0;
                    const dailyTotalClass = dailyPercentage >= 75 ? 'text-success' : dailyPercentage >= 50 ? 'text-warning' : 'text-danger';
                    row += `<td class="text-center"><strong class="${dailyTotalClass}">${dayPresentCount}/${dayTotalClasses}</strong></td>`;
                    
                    // Cumulative percentage
                    const cumulativePercentage = totalPossibleClasses > 0 ? Math.round((totalAttendedClasses / totalPossibleClasses) * 100) : 0;
                    const percentageClass = cumulativePercentage >= 75 ? 'text-success' : cumulativePercentage >= 50 ? 'text-warning' : 'text-danger';
                    row += `<td class="text-center"><strong class="${percentageClass}">${cumulativePercentage}%</strong></td>`;
                    
                    row += '</tr>';
                    tbody.innerHTML += row;
                });
                
                // Add summary row at the bottom
                const overallPercentage = totalPossibleClasses > 0 ? Math.round((totalAttendedClasses / totalPossibleClasses) * 100) : 0;
                const summaryClass = overallPercentage >= 75 ? 'table-success' : overallPercentage >= 50 ? 'table-warning' : 'table-danger';
                
                const summaryRow = `
                    <tr class="${summaryClass} fw-bold">
                        <td class="sticky-left">OVERALL</td>
                        ${displaySubjects.map(() => '<td class="text-center">-</td>').join('')}
                        <td class="text-center">${totalAttendedClasses}/${totalPossibleClasses}</td>
                        <td class="text-center">${overallPercentage}%</td>
                    </tr>
                `;
                tbody.innerHTML += summaryRow;
                
                // Update profile attendance percentage
                document.getElementById('profileAttendance').textContent = overallPercentage + '%';
                
            } catch (error) {
                console.error('Error loading attendance history:', error);
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-danger">Error loading attendance history</td></tr>';
            }
        }

        // Update SGPA Chart
        function updateSGPAChart(sgpas) {
            const container = document.getElementById('sgpaChart');
            
            if (!sgpas || Object.keys(sgpas).length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-4">No SGPA data available</div>';
                return;
            }
            
            const semesters = Object.keys(sgpas);
            const values = Object.values(sgpas).map(v => parseFloat(v) || 0);
            
            const trace = {
                x: semesters.map(s => `Sem ${s}`),
                y: values,
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: '#667eea', width: 3 },
                marker: { color: '#667eea', size: 8 }
            };
            
            const layout = {
                title: 'SGPA Performance',
                xaxis: { title: 'Semester' },
                yaxis: { title: 'SGPA', range: [0, 10] },
                margin: { l: 50, r: 50, t: 50, b: 50 }
            };
            
            Plotly.newPlot(container, [trace], layout, { responsive: true });
        }

        // Load Attendance Data
        async function loadAttendanceData() {
            if (!currentSection) return;
            
            try {
                // This would fetch attendance data from the server
                // For now, using placeholder data
                updateAttendanceTable();
            } catch (error) {
                console.error('Error loading attendance data:', error);
            }
        }

        // Update Attendance Table
        function updateAttendanceTable(students = null) {
            const tbody = document.getElementById('attendanceTableBody');
            
            // Use provided students or current section students
            const studentsToDisplay = students || window.currentSectionStudents || [];
            
            if (!studentsToDisplay || studentsToDisplay.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            <div class="empty-state">
                                <i class="bi bi-people text-muted" style="font-size: 2rem;"></i>
                                <p class="mt-2 mb-0">${currentSection ? 'No students found in this section' : 'Please select a section to view attendance'}</p>
                                <small class="text-muted">Students will appear here once a section is selected</small>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = '';
            
            studentsToDisplay.forEach((student, index) => {
                const rollNumber = student.rollNo || student.roll_number || student;
                const studentName = student.name || `Student ${rollNumber}`;
                const mobile = student.mobile || 'N/A';
                
                // Check if student is present (in the presentStudents set)
                const isPresent = presentStudents.has(rollNumber);
                const statusClass = isPresent ? 'text-success' : 'text-danger';
                const statusIcon = isPresent ? 'bi-check-circle-fill' : 'bi-x-circle-fill';
                const statusText = isPresent ? 'Present' : 'Absent';
                
                const row = `
                    <tr class="attendance-row ${isPresent ? 'row-present' : 'row-absent'}" onclick="showStudentProfile('${rollNumber}')">
                        <td class="text-center">
                            <div class="student-photo-container">
                                <img src="https://gietuerp.in/StudentDocuments/${rollNumber}/${rollNumber}.JPG" 
                                     class="student-photo"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" 
                                     alt="${rollNumber}">
                                <div class="photo-placeholder" style="display: none;">
                                    <span>${rollNumber.slice(-2)}</span>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="student-info">
                                <div class="student-id">${rollNumber}</div>
                                <small class="student-section text-muted">${currentSection || 'N/A'}</small>
                            </div>
                        </td>
                        <td>
                            <div class="student-name">${studentName}</div>
                        </td>
                        <td>
                            <div class="student-mobile">
                                <i class="bi bi-phone text-muted me-1"></i>
                                <span>${mobile}</span>
                            </div>
                        </td>
                        <td class="text-center">
                            <span class="attendance-status-badge ${isPresent ? 'status-present' : 'status-absent'}">
                                <i class="bi ${statusIcon}"></i>
                                <span class="status-text">${statusText}</span>
                            </span>
                        </td>
                        <td class="text-center">
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-outline-primary action-btn" onclick="event.stopPropagation(); showStudentProfile('${rollNumber}')" title="View Profile">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary action-btn" onclick="event.stopPropagation(); toggleAttendance('${rollNumber}')" title="Toggle Attendance">
                                    <i class="bi ${isPresent ? 'bi-x-circle' : 'bi-check-circle'}"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            
            // Update footer stats
            updateAttendanceFooterStats();
            updateDashboardStats();
        }
        
        // Update Attendance Footer Stats
        function updateAttendanceFooterStats() {
            const total = window.currentSectionStudents ? window.currentSectionStudents.length : 0;
            const present = presentStudents.size;
            const absent = total - present;
            const percentage = total > 0 ? Math.round((present / total) * 100) : 0;
            
            document.getElementById('totalStudentsCount').textContent = total;
            document.getElementById('presentStudentsCount').textContent = present;
            document.getElementById('absentStudentsCount').textContent = absent;
            document.getElementById('attendancePercentage').textContent = percentage + '%';
            
            // Enable/disable submit button
            const submitBtn = document.getElementById('submitAttendanceBtn');
            if (submitBtn) {
                submitBtn.disabled = total === 0;
            }
        }

        // Initialize Charts
        function initializeCharts() {
            const ctx = document.getElementById('attendanceChart').getContext('2d');
            attendanceChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Present', 'Absent'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['#10b981', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Update Quick Stats
        function updateQuickStats(presentCount = null, totalStudents = null) {
            // Get current counts
            const currentPresentCount = presentCount !== null ? presentCount : presentStudents.size;
            const currentTotalStudents = totalStudents !== null ? totalStudents : 
                (window.currentSectionStudents ? window.currentSectionStudents.length : 0);
            const currentAbsentCount = Math.max(0, currentTotalStudents - currentPresentCount);
            
            // Calculate attendance rate
            const attendanceRate = currentTotalStudents > 0 ? 
                Math.round((currentPresentCount / currentTotalStudents) * 100) : 0;
            
            // Update sidebar stats
            document.getElementById('presentCount').textContent = currentPresentCount;
            document.getElementById('attendanceRate').textContent = attendanceRate + '%';
            
            // Update main stats
            document.getElementById('presentStudents').textContent = currentPresentCount;
            document.getElementById('absentStudents').textContent = currentAbsentCount;
            
            // Update present count badge if it exists
            const presentCountBadge = document.getElementById('presentCountBadge');
            if (presentCountBadge) {
                presentCountBadge.textContent = currentPresentCount;
            }
            
            // Update chart
            if (attendanceChart) {
                attendanceChart.data.datasets[0].data = [currentPresentCount, currentAbsentCount];
                attendanceChart.data.labels = [`Present (${currentPresentCount})`, `Absent (${currentAbsentCount})`];
                attendanceChart.update();
            }
            
            // Update section display with real-time stats
            updateSectionStatsDisplay(currentPresentCount, currentAbsentCount, attendanceRate);
        }
        
        // Update Section Stats Display
        function updateSectionStatsDisplay(presentCount, absentCount, attendanceRate) {
            const sectionLabels = document.querySelectorAll('.section-label');
            sectionLabels.forEach(label => {
                const inputElement = label.querySelector('input');
                if (inputElement && inputElement.value === currentSection) {
                    const statsDiv = label.querySelector('.section-stats');
                    if (statsDiv) {
                        statsDiv.innerHTML = `
                            <span class="badge badge-primary">Total: ${presentCount + absentCount}</span>
                            <span class="badge badge-success">Present: ${presentCount}</span>
                            <span class="badge badge-danger">Absent: ${absentCount}</span>
                            <span class="badge badge-info">Rate: ${attendanceRate}%</span>
                        `;
                    }
                }
            });
        }


        // Export Functions
        async function exportToExcel() {
            if (!currentSection) {
                showNotification('Please select a section first', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`/api/export_excel?section=${currentSection}`);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `attendance_${currentSection}_${new Date().toISOString().split('T')[0]}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    showNotification('Excel file downloaded successfully', 'success');
                } else {
                    showNotification('Failed to export Excel file', 'error');
                }
            } catch (error) {
                console.error('Error exporting Excel:', error);
                showNotification('Network error. Please try again.', 'error');
            }
        }

        async function exportToCSV() {
            if (!currentSection) {
                showNotification('Please select a section first', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`/api/export_csv?section=${currentSection}`);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `attendance_${currentSection}_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    showNotification('CSV file downloaded successfully', 'success');
                } else {
                    showNotification('Failed to export CSV file', 'error');
                }
            } catch (error) {
                console.error('Error exporting CSV:', error);
                showNotification('Network error. Please try again.', 'error');
            }
        }

        function generatePDFReport() {
            showNotification('PDF report generation will be implemented soon', 'info');
        }

        // Email Functions
        function openEmailModal() {
            const modal = new bootstrap.Modal(document.getElementById('emailModal'));
            modal.show();
        }

        async function sendEmailReports() {
            const recipients = document.getElementById('emailRecipients').value;
            const subject = document.getElementById('emailSubject').value;
            const message = document.getElementById('emailMessage').value;
            const attachReport = document.getElementById('attachReportCheck').checked;
            
            if (!currentSection) {
                showNotification('Please select a section first', 'warning');
                return;
            }
            
            try {
                const response = await fetch('/api/send_attendance_emails', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        recipients: recipients,
                        subject: subject,
                        message: message,
                        attach_report: attachReport,
                        section: currentSection
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('Email reports sent successfully', 'success');
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('emailModal'));
                    modal.hide();
                } else {
                    showNotification(result.message || 'Failed to send email reports', 'error');
                }
            } catch (error) {
                console.error('Error sending email reports:', error);
                showNotification('Network error. Please try again.', 'error');
            }
        }

        function sendIndividualEmail() {
            const rollNumber = document.getElementById('profileRoll').textContent;
            
            // Implementation for sending individual email
            showNotification(`Email sent to ${rollNumber}`, 'success');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('studentProfileModal'));
            modal.hide();
        }

        // Manual Attendance Modal Functions
        function openManualAttendanceModal() {
            if (!currentSection) {
                showNotification('Please select a section first', 'warning');
                return;
            }
            
            // Load students for manual attendance
            loadManualAttendanceStudents();
            
            const modal = new bootstrap.Modal(document.getElementById('manualAttendanceModal'));
            modal.show();
        }

        async function loadManualAttendanceStudents() {
            const individualTbody = document.getElementById('manualAttendanceBody');
            const bulkTbody = document.getElementById('bulkAttendanceBody');
            
            individualTbody.innerHTML = '<tr><td colspan="4" class="text-center"><div class="spinner-border spinner-border-sm me-2"></div>Loading students...</td></tr>';
            bulkTbody.innerHTML = '<tr><td colspan="5" class="text-center"><div class="spinner-border spinner-border-sm me-2"></div>Loading students...</td></tr>';
            
            try {
                // Fetch students for the current section
                const response = await fetch(`/api/section_students?section=${currentSection}`);
                const result = await response.json();
                
                if (result.success && result.students) {
                    // Update total students count
                    const totalStudents = result.students.length;
                    document.getElementById('totalStudentsCount').textContent = totalStudents;
                    document.getElementById('absentCountModal').textContent = totalStudents;
                    
                    // Clear both tables
                    individualTbody.innerHTML = '';
                    bulkTbody.innerHTML = '';
                    
                    result.students.forEach((student, index) => {
                        const rollNumber = student.rollNo || student.roll_number || student;
                        const studentName = student.name || `Student ${rollNumber}`;
                        const mobile = student.mobile || 'N/A';
                        const isPresent = presentStudents.has(rollNumber);
                        
                        // Individual entry row
                        const individualRow = `
                            <tr data-roll="${rollNumber}">
                                <td><strong>${rollNumber}</strong></td>
                                <td>${studentName}</td>
                                <td><small class="text-muted">${mobile}</small></td>
                                <td>
                                    <button type="button" 
                                            class="status-toggle-btn ${isPresent ? 'present' : 'absent'}" 
                                            data-roll="${rollNumber}"
                                            onclick="toggleStudentStatus('${rollNumber}')">
                                        <i class="bi ${isPresent ? 'bi-check-circle' : 'bi-x-circle'}"></i>
                                        ${isPresent ? 'Present' : 'Absent'}
                                    </button>
                                </td>
                            </tr>
                        `;
                        individualTbody.innerHTML += individualRow;
                        
                        // Bulk entry row
                        const bulkRow = `
                            <tr data-roll="${rollNumber}">
                                <td><input type="checkbox" class="student-checkbox" data-roll="${rollNumber}" onchange="toggleBulkSelection(this)"></td>
                                <td><strong>${rollNumber}</strong></td>
                                <td>${studentName}</td>
                                <td><small class="text-muted">${mobile}</small></td>
                                <td>
                                    <span class="attendance-badge ${isPresent ? 'badge-present' : 'badge-absent'}" id="bulk-status-${rollNumber}">
                                        <i class="bi ${isPresent ? 'bi-check-circle' : 'bi-x-circle'}"></i>
                                        ${isPresent ? 'Present' : 'Absent'}
                                    </span>
                                </td>
                            </tr>
                        `;
                        bulkTbody.innerHTML += bulkRow;
                    });
                    
                    // Update counts after loading
                    updateManualAttendanceCounts();
                } else {
                    individualTbody.innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center text-muted">No students found</td>
                        </tr>
                    `;
                    bulkTbody.innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center text-muted">
                                <i class="bi bi-exclamation-triangle"></i>
                                No students found for this section
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Error loading students:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-danger">
                            <i class="bi bi-exclamation-triangle"></i>
                            Error loading students. Please try again.
                        </td>
                    </tr>
                `;
            }
        }

        // Toggle student status in manual attendance
        function toggleStudentStatus(rollNumber) {
            const button = document.querySelector(`.status-toggle-btn[data-roll="${rollNumber}"]`);
            
            if (!button) {
                console.error('Button not found for roll number:', rollNumber);
                return;
            }
            
            const isPresent = button.classList.contains('present');
            
            if (isPresent) {
                // Mark as absent
                button.classList.remove('present');
                button.classList.add('absent');
                button.innerHTML = '<i class="bi bi-x-circle"></i> Absent';
                presentStudents.delete(rollNumber);
            } else {
                // Mark as present
                button.classList.remove('absent');
                button.classList.add('present');
                button.innerHTML = '<i class="bi bi-check-circle"></i> Present';
                presentStudents.add(rollNumber);
            }
            
            // Update counts
            updateManualAttendanceCounts();
        }
        
        // Mark all students as present
        function markAllPresent() {
            const bulkTbody = document.getElementById('bulkAttendanceBody');
            const rows = bulkTbody.querySelectorAll('tr[data-roll]');
            
            rows.forEach(row => {
                const rollNumber = row.getAttribute('data-roll');
                const checkbox = row.querySelector('input[type="checkbox"]');
                const statusCell = row.querySelector('.attendance-status');
                
                if (checkbox) {
                    checkbox.checked = true;
                }
                
                if (statusCell) {
                    statusCell.innerHTML = '<span class="badge bg-success">Present</span>';
                }
                
                presentStudents.add(rollNumber);
            });
            
            updateManualAttendanceCounts();
        }
        
        // Mark all students as absent
        function markAllAbsent() {
            const bulkTbody = document.getElementById('bulkAttendanceBody');
            const rows = bulkTbody.querySelectorAll('tr[data-roll]');
            
            rows.forEach(row => {
                const rollNumber = row.getAttribute('data-roll');
                const checkbox = row.querySelector('input[type="checkbox"]');
                const statusCell = row.querySelector('.attendance-status');
                
                if (checkbox) {
                    checkbox.checked = false;
                }
                
                if (statusCell) {
                    statusCell.innerHTML = '<span class="badge bg-danger">Absent</span>';
                }
                
                presentStudents.delete(rollNumber);
            });
            
            updateManualAttendanceCounts();
        }
        
        // Update attendance counts in modal
        function updateManualAttendanceCounts() {
            const individualTbody = document.getElementById('individualAttendanceBody');
            const bulkTbody = document.getElementById('bulkAttendanceBody');
            
            // Count only valid students (exclude dropped students with ERR_HTTP2_PROTOCOL_ERROR)
            const validStudents = Array.from(document.querySelectorAll('#individualAttendanceBody tr[data-roll], #bulkAttendanceBody tr[data-roll]'))
                .filter(row => {
                    const rollNumber = row.getAttribute('data-roll');
                    return !rollNumber.includes('ERR_HTTP2_PROTOCOL_ERROR');
                });
            
            const totalStudents = validStudents.length;
            const presentCount = presentStudents.size;
            const absentCount = totalStudents - presentCount;
            const attendanceRate = totalStudents > 0 ? Math.round((presentCount / totalStudents) * 100) : 0;
            
            // Update counts in the stats cards
            document.getElementById('totalStudentsCount').textContent = totalStudents;
            document.getElementById('presentCountModal').textContent = presentCount;
            document.getElementById('absentCountModal').textContent = absentCount;
            document.getElementById('attendanceRateModal').textContent = `${attendanceRate}%`;
        }

        async function saveManualAttendance() {
            // Get active tab
            const activeTab = document.querySelector('.manual-tab.active').getAttribute('data-tab');
            const tbody = activeTab === 'individual' ? 
                document.getElementById('individualAttendanceBody') : 
                document.getElementById('bulkAttendanceBody');
            
            const rows = tbody.querySelectorAll('tr[data-roll]');
            const attendanceData = [];
            
            // Extract attendance data from the toggle buttons or checkboxes
            rows.forEach(row => {
                const rollNumber = row.getAttribute('data-roll');
                
                // For bulk entry, check the checkbox status
                if (activeTab === 'bulk') {
                    const checkbox = row.querySelector('input[type="checkbox"]');
                    if (checkbox && checkbox.checked) {
                        presentStudents.add(rollNumber);
                    } else {
                        presentStudents.delete(rollNumber);
                    }
                }
                
                const button = row.querySelector('.status-toggle-btn');
                
                // Skip dropped students (identified by ERR_HTTP2_PROTOCOL_ERROR)
                if (rollNumber && rollNumber.includes('ERR_HTTP2_PROTOCOL_ERROR')) {
                    console.log('Skipping dropped student:', rollNumber);
                    return; // Skip this student
                }
                
                if (rollNumber && button) {
                    const status = button.classList.contains('present') ? 'present' : 'absent';
                    attendanceData.push({
                        roll_number: rollNumber,
                        status: status
                    });
                }
            });
            
            if (attendanceData.length === 0) {
                showNotification('No attendance data to save', 'warning');
                return;
            }
            
            try {
                const response = await fetch('/api/save_manual_attendance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        section: currentSection,
                        attendance: attendanceData
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Manual attendance saved successfully', 'success');
                    
                    // Update present students set
                    presentStudents.clear();
                    attendanceData.forEach(item => {
                        if (item.status === 'present') {
                            presentStudents.add(item.roll_number);
                        }
                    });
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('manualAttendanceModal'));
                    modal.hide();
                    
                    // Update UI
                    updateAttendanceTable();
                    updateQuickStats(presentStudents.size);
                    updatePresentStudentsList(Array.from(presentStudents));
                } else {
                    showNotification(result.message || 'Failed to save manual attendance', 'error');
                }
            } catch (error) {
                console.error('Error saving manual attendance:', error);
                showNotification('Network error. Please try again.', 'error');
            }
        }

        // Navigation Functions
        function showSection(sectionName) {
            // Hide all content sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none';
            });
            
            // Show selected section
            const targetSection = document.getElementById(sectionName + 'Section');
            if (targetSection) {
                targetSection.classList.add('active');
                targetSection.style.display = 'block';
            }
            
            // Update active nav link
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Load section-specific content
            switch(sectionName) {
                case 'dashboard':
                    loadDashboardOverview();
                    break;
                case 'attendance':
                    loadAttendanceSection();
                    break;
                case 'manual':
                    loadManualSection();
                    break;
                case 'reports':
                    loadReportsSection();
                    break;
            }
        }
        
        // Section Loading Functions
        function loadDashboardOverview() {
            if (currentSection) {
                document.getElementById('dashboardOverview').style.display = 'block';
                updateDashboardStats();
            }
        }
        
        function loadAttendanceSection() {
            // Move control panel and camera to attendance section
            const controlPanel = document.querySelector('.control-panel');
            const cameraSection = document.querySelector('.camera-section');
            const attendanceTableSection = document.querySelector('.attendance-table-section');
            
            const attendanceContainer = document.getElementById('attendanceSection');
            if (controlPanel && attendanceContainer) {
                attendanceContainer.appendChild(controlPanel);
            }
            if (cameraSection && attendanceContainer) {
                attendanceContainer.appendChild(cameraSection);
            }
            if (attendanceTableSection && attendanceContainer) {
                attendanceContainer.appendChild(attendanceTableSection);
            }
        }
        
        function loadManualSection() {
            // Show manual attendance button
            showNotification('Manual attendance entry available via the Manual Entry button in the table actions', 'info');
        }
        
        function loadReportsSection() {
            // Move export section to reports
            const exportSection = document.querySelector('.export-section');
            const reportsContainer = document.getElementById('reportsSection');
            if (exportSection && reportsContainer) {
                reportsContainer.appendChild(exportSection);
            }
        }
        
        // Submit Attendance Function
        async function submitAttendance() {
            if (!currentSection) {
                showNotification('Please select a section first', 'warning');
                return;
            }
            
            if (presentStudents.size === 0) {
                const result = await confirmDialog('No students marked present. Do you want to submit with all students absent?');
                if (!result) return;
            }
            
            try {
                const attendanceData = [];
                const allStudents = window.currentSectionStudents || [];
                
                allStudents.forEach(student => {
                    const rollNumber = student.rollNo || student.roll_number || student;
                    attendanceData.push({
                        roll_number: rollNumber,
                        status: presentStudents.has(rollNumber) ? 'present' : 'absent'
                    });
                });
                
                const response = await fetch('/api/save_manual_attendance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        section: currentSection,
                        attendance: attendanceData
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Attendance submitted successfully!', 'success');
                    document.getElementById('submitAttendanceBtn').disabled = true;
                    
                    // Send absence emails if there are absent students
                    const absentStudents = allStudents.filter(student => {
                        const rollNumber = student.rollNo || student.roll_number || student;
                        return !presentStudents.has(rollNumber);
                    });
                    
                    if (absentStudents.length > 0) {
                        showNotification(`Sending absence notifications to ${absentStudents.length} students...`, 'info');
                        // The backend will handle sending emails
                    }
                } else {
                    showNotification(result.message || 'Failed to submit attendance', 'error');
                }
            } catch (error) {
                console.error('Error submitting attendance:', error);
                showNotification('Network error. Please try again.', 'error');
            }
        }
        
        // Reset Attendance Function
        function resetAttendance() {
            if (presentStudents.size === 0) {
                showNotification('No attendance data to reset', 'info');
                return;
            }
            
            presentStudents.clear();
            updateAttendanceTable();
            updateQuickStats();
            updatePresentStudentsList([]);
            document.getElementById('submitAttendanceBtn').disabled = false;
            showNotification('Attendance data reset successfully', 'success');
        }
        
        // Update Dashboard Stats
        function updateDashboardStats() {
            if (!window.currentSectionStudents) return;
            
            const total = window.currentSectionStudents.length;
            const present = presentStudents.size;
            const absent = total - present;
            const percentage = total > 0 ? Math.round((present / total) * 100) : 0;
            
            document.getElementById('overviewTotal').textContent = total;
            document.getElementById('overviewPresent').textContent = present;
            document.getElementById('overviewAbsent').textContent = absent;
            document.getElementById('overviewPercentage').textContent = percentage + '%';
        }
        
        // Confirmation Dialog
        function confirmDialog(message) {
            return new Promise((resolve) => {
                const result = confirm(message);
                resolve(result);
            });
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('show');
        }

        function refreshData() {
            loadSections();
            updateAttendanceTable();
            updateQuickStats();
            showNotification('Data refreshed', 'success');
        }

        function showHelp() {
            showNotification('Help documentation will be available soon', 'info');
        }

        function showTeacherProfile() {
            showNotification('Teacher profile feature will be implemented soon', 'info');
        }

        function refreshAttendanceTable() {
            updateAttendanceTable();
            showNotification('Attendance table refreshed', 'success');
        }

        function exportTableData() {
            exportToExcel();
        }

        function generateReport() {
            showNotification('Comprehensive report generation in progress...', 'info');
        }

        function toggleAttendance(rollNumber) {
            if (presentStudents.has(rollNumber)) {
                presentStudents.delete(rollNumber);
                showNotification(`${rollNumber} marked as absent`, 'warning');
            } else {
                presentStudents.add(rollNumber);
                showNotification(`${rollNumber} marked as present`, 'success');
            }
            
            // Update UI
            updateAttendanceTable();
            updateQuickStats();
            updatePresentStudentsList(Array.from(presentStudents));
        }
        
        function refreshPresentStudents() {
            // Refresh present students list
            if (isAttendanceActive) {
                updateRecognitionStatus();
            }
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Sidebar resize handler
            window.addEventListener('resize', function() {
                if (window.innerWidth >= 1200) {
                    document.getElementById('sidebar').classList.remove('show');
                }
            });
            
            // Auto-refresh present students list
            setInterval(() => {
                if (isAttendanceActive) {
                    updateRecognitionStatus();
                }
            }, 2000);
        }

        // Start Periodic Updates
        function startPeriodicUpdates() {
            // Update quick stats every 30 seconds
            setInterval(() => {
                updateQuickStats();
            }, 30000);
        }

        // Notification System
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Add to document
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // Error Handling
        window.addEventListener('error', function(event) {
            console.error('JavaScript error:', event.error);
        });

        // Handle fetch errors globally
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            return originalFetch.apply(this, args).catch(error => {
                console.error('Network error:', error);
                throw error;
            });
        };
    </script>

    <!-- Email Confirmation Modal -->
    <div class="modal fade" id="emailConfirmModal" tabindex="-1" aria-labelledby="emailConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="emailConfirmModalLabel">
                        <i class="bi bi-envelope"></i> Send Absence Notifications
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex align-items-start mb-3">
                        <div class="flex-shrink-0">
                            <i class="bi bi-question-circle-fill text-warning" style="font-size: 2rem;"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-2">Send email notifications to absent students?</h6>
                            <p class="mb-2 text-muted">We found <span id="absentCount" class="fw-bold text-danger">0</span> absent students.</p>
                            <p class="small text-muted mb-0">
                                Email notifications will include:
                            </p>
                            <ul class="small text-muted mt-1">
                                <li>Current attendance percentage</li>
                                <li>Academic performance (SGPA/CGPA)</li>
                                <li>Required classes to meet 80% attendance</li>
                                <li>Counseling and guidance message</li>
                            </ul>
                        </div>
                    </div>
                    <div class="alert alert-info small" role="alert">
                        <i class="bi bi-info-circle"></i>
                        <strong>Note:</strong> Emails will be sent to students' official college email addresses.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="skipEmails">
                        <i class="bi bi-x-circle"></i> Skip Emails
                    </button>
                    <button type="button" class="btn btn-primary" id="confirmSendEmails">
                        <i class="bi bi-send"></i> Send Notifications
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
