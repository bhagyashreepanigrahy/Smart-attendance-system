<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Attendance Management - GIET University</title>
    <meta name="description" content="Professional online attendance management system for virtual classrooms.">
    <meta name="theme-color" content="#667eea">
    
    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- CSS Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    
    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --danger-gradient: linear-gradient(135deg, #ff6b6b 0%, #ffa726 100%);
            --warning-gradient: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            --dark-gradient: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            
            --glass-background: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.18);
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --bg-light: #f7fafc;
            --shadow-light: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-heavy: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --border-radius: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-light);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Sidebar Styles - Same as offline system */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: var(--dark-gradient);
            color: white;
            z-index: 1000;
            transition: var(--transition);
            overflow-y: auto;
            box-shadow: var(--shadow-medium);
        }

        .sidebar-header {
            padding: 2rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .sidebar-header .logo {
            width: 60px;
            height: 60px;
            background: var(--secondary-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.5rem;
            box-shadow: var(--shadow-light);
        }

        .sidebar-header h4 {
            margin: 0;
            font-weight: 700;
            font-size: 1.25rem;
            background: linear-gradient(135deg, #ffffff 0%, #e2e8f0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .sidebar-header p {
            margin: 0.25rem 0 0;
            font-size: 0.85rem;
            opacity: 0.7;
        }

        .user-profile {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            background: var(--secondary-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .user-info h6 {
            margin: 0;
            font-weight: 600;
            font-size: 1rem;
        }

        .user-info p {
            margin: 0;
            font-size: 0.8rem;
            opacity: 0.8;
        }

        /* Main Content */
        .main-content {
            margin-left: 280px;
            padding: 2rem;
            min-height: 100vh;
            transition: var(--transition);
        }

        .page-header {
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            margin-bottom: 2rem;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .page-title {
            font-size: 2.5rem;
            font-weight: 800;
            font-family: 'Poppins', sans-serif;
            margin: 0 0 0.5rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .page-subtitle {
            color: var(--text-secondary);
            margin: 0;
            font-size: 1.1rem;
        }

        /* Control Panel */
        .control-panel {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .control-card {
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: var(--transition);
        }

        .control-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-medium);
        }

        .control-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
        }

        .control-title {
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.25rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            display: block;
            font-size: 0.95rem;
        }

        .form-control, .form-select {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            transition: var(--transition);
            width: 100%;
        }

        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn-control {
            padding: 1rem 2rem;
            border-radius: 50px;
            font-weight: 600;
            border: none;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            text-decoration: none;
            justify-content: center;
            min-width: 180px;
        }

        .btn-control::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn-control:hover::before {
            left: 100%;
        }

        .btn-start {
            background: var(--success-gradient);
            color: white;
        }

        .btn-start:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-medium);
        }

        .btn-quick-poll {
            background: var(--warning-gradient);
            color: white;
        }

        .btn-save {
            background: var(--secondary-gradient);
            color: white;
        }

        .btn-manage {
            background: var(--primary-gradient);
            color: white;
        }

        /* Session Status */
        .session-status {
            padding: 2rem;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .status-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: #fee2e2;
            color: #dc2626;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .status-indicator.active {
            background: #dcfce7;
            color: #16a34a;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .session-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .detail-item {
            text-align: center;
            padding: 1.5rem;
            background: #f8fafc;
            border-radius: var(--border-radius);
            border: 1px solid #e2e8f0;
        }

        .detail-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-family: 'Poppins', sans-serif;
        }

        .detail-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Student List - Same as offline system */
        .students-section {
            margin-top: 2rem;
        }

        .students-container {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            border: 1px solid rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .students-header {
            padding: 2rem;
            border-bottom: 1px solid #e2e8f0;
            background: var(--primary-gradient);
            color: white;
        }

        .students-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0 0 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .students-count {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .students-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .attendance-summary {
            display: flex;
            gap: 1rem;
        }

        .summary-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .summary-present {
            background: #dcfce7;
            color: #166534;
        }

        .summary-absent {
            background: #fee2e2;
            color: #991b1b;
        }

        .summary-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .students-table-container {
            max-height: 600px;
            overflow-y: auto;
        }

        .students-table {
            width: 100%;
            margin: 0;
            font-size: 0.95rem;
        }

        .students-table th {
            background: #f8fafc;
            color: var(--text-primary);
            font-weight: 600;
            padding: 1rem;
            border: none;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid #e2e8f0;
        }

        .students-table td {
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: middle;
        }

        .students-table tr:hover {
            background: #f8fafc;
        }

        .student-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .student-photo-container {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 2px solid #fff;
        }
        
        .student-photo-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        
        .student-photo-fallback {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: var(--secondary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            font-size: 0.85rem;
        }
        
        /* Legacy support for old student-photo class */
        .student-photo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--secondary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .student-details h6 {
            margin: 0;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .student-details p {
            margin: 0;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .status-toggle-btn {
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            transition: var(--transition);
            cursor: pointer;
            min-width: 80px;
        }

        .status-toggle-btn.present {
            background: #16a34a;
            color: white;
        }

        .status-toggle-btn.absent {
            background: #dc2626;
            color: white;
        }

        .status-toggle-btn.pending {
            background: #d97706;
            color: white;
        }

        .status-toggle-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* Action buttons */
        .session-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .main-content {
                margin-left: 0;
            }

            .control-panel {
                grid-template-columns: 1fr;
            }

            .session-actions {
                flex-direction: column;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 1rem;
            }

            .page-title {
                font-size: 2rem;
            }

            .control-card {
                padding: 1.5rem;
            }

            .btn-control {
                width: 100%;
                margin-bottom: 1rem;
            }
        }
    </style>
</head>

<body>
    <!-- Sidebar - Same as offline system -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <i class="bi bi-mortarboard-fill"></i>
            </div>
            <h4>GIET University</h4>
            <p>Online Attendance System</p>
        </div>

        <div class="user-profile">
            <div class="user-avatar">
                {{ faculty_name[0] if faculty_name else 'F' }}
            </div>
            <div class="user-info">
                <h6>{{ faculty_name }}</h6>
                <p>Faculty Member</p>
            </div>
        </div>

        <nav class="nav-section">
            <div class="nav-section-title">Management</div>
            <div class="nav-item">
                <a href="/dashboard" class="nav-link">
                    <i class="bi bi-house-door"></i>
                    Dashboard
                </a>
            </div>
            <div class="nav-item">
                <a href="/online_attendance" class="nav-link active">
                    <i class="bi bi-camera-video"></i>
                    Online Attendance
                </a>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">
                <i class="bi bi-camera-video me-3"></i>
                Online Attendance Management
            </h1>
            <p class="page-subtitle">
                Manage virtual classroom attendance with real-time student tracking
            </p>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <!-- Session Creation -->
            <div class="control-card">
                <div class="control-header">
                    <h3 class="control-title">
                        <i class="bi bi-plus-circle"></i>
                        Create Online Session
                    </h3>
                </div>

                <form id="sessionForm">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="bi bi-people me-2"></i>Section
                        </label>
                        <select class="form-select" id="section_select" required>
                            <option value="">Select Section</option>
                            {% for section_id, section_info in sections.items() %}
                            <option value="{{ section_id }}">{{ section_info.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <i class="bi bi-book me-2"></i>Subject
                        </label>
                        <select class="form-select" id="subject_select" required>
                            <option value="">Select Subject</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <i class="bi bi-calendar-check me-2"></i>Class Type
                        </label>
                        <select class="form-select" id="class_type">
                            <option value="lecture">Lecture</option>
                            <option value="tutorial">Tutorial</option>
                            <option value="practical">Practical</option>
                            <option value="seminar">Seminar</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <i class="bi bi-clock me-2"></i>Duration (minutes)
                        </label>
                        <input type="number" class="form-control" id="duration_input" 
                               value="90" min="15" max="300" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <i class="bi bi-camera-video me-2"></i>Jitsi Meeting Link
                        </label>
                        <input type="url" class="form-control" id="jitsi_link" 
                               placeholder="https://meet.jit.si/YourClassName" required>
                        <small class="form-text text-muted mt-2">
                            Required for interactive attendance popups
                        </small>
                    </div>

                    <button type="submit" class="btn-control btn-start w-100" onclick="createSession()">
                        <i class="bi bi-play-fill"></i>
                        Start Online Session
                    </button>
                </form>
            </div>

            <!-- Session Status -->
            <div class="control-card">
                <div class="control-header">
                    <h3 class="control-title">
                        <i class="bi bi-activity"></i>
                        Current Session Status
                    </h3>
                </div>

                <div id="session-status">
                    <div class="text-center py-5">
                        <div class="status-indicator">
                            <div class="status-dot"></div>
                            No Active Session
                        </div>
                        <p class="mt-3 text-muted">Create a session to start taking online attendance</p>
                    </div>
                </div>

                <div id="session-actions" class="session-actions mt-4" style="display: none;">
                    <button class="btn-control btn-quick-poll" onclick="sendQuickPoll()">
                        <i class="bi bi-lightning"></i>
                        Quick Poll (30s)
                    </button>
                    <button class="btn-control btn-save" onclick="saveAttendance()">
                        <i class="bi bi-download"></i>
                        Save Attendance
                    </button>
                    <button class="btn-control btn-manage" onclick="manageSession()">
                        <i class="bi bi-gear"></i>
                        Manage Session
                    </button>
                </div>
            </div>
        </div>

        <!-- Students Section - Same design as offline system -->
        <div class="students-section" id="students-section" style="display: none;">
            <div class="students-container">
                <div class="students-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="students-title">
                            <i class="bi bi-people-fill"></i>
                            Student Attendance List
                        </h3>
                        <div class="students-count" id="total-students">
                            0 Students
                        </div>
                    </div>
                </div>

                <div class="students-controls">
                    <div class="attendance-summary" id="attendance-summary">
                        <div class="summary-item summary-present">
                            <i class="bi bi-check-circle"></i>
                            Present: <span id="present-count">0</span>
                        </div>
                        <div class="summary-item summary-absent">
                            <i class="bi bi-x-circle"></i>
                            Absent: <span id="absent-count">0</span>
                        </div>
                        <div class="summary-item summary-pending">
                            <i class="bi bi-clock"></i>
                            Pending: <span id="pending-count">0</span>
                        </div>
                    </div>
                    
                    <div class="controls-right">
                        <button class="btn btn-sm btn-outline-primary" onclick="markAllPresent()">
                            <i class="bi bi-check-all"></i> All Present
                        </button>
                        <button class="btn btn-sm btn-outline-danger ms-2" onclick="markAllAbsent()">
                            <i class="bi bi-x-lg"></i> All Absent
                        </button>
                    </div>
                </div>

                <div class="students-table-container">
                    <table class="table students-table">
                        <thead>
                            <tr>
                                <th width="5%">#</th>
                                <th width="40%">Student Details</th>
                                <th width="20%">Roll Number</th>
                                <th width="20%">Response Time</th>
                                <th width="15%">Status</th>
                            </tr>
                        </thead>
                        <tbody id="students-table-body">
                            <!-- Students will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 9999;">
        <div id="toast" class="toast hide" role="alert">
            <div class="toast-header">
                <i class="bi bi-info-circle me-2"></i>
                <strong class="me-auto">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toast-body">
                <!-- Toast message -->
            </div>
        </div>
    </div>

    <!-- Session Management Modal -->
    <div class="modal fade" id="sessionManagementModal" tabindex="-1" aria-labelledby="sessionManagementModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title d-flex align-items-center gap-2" id="sessionManagementModalLabel">
                        <i class="bi bi-gear-fill"></i>
                        Session Management
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body p-4">
                    <!-- Session Overview -->
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <div class="card h-100">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0">
                                        <i class="bi bi-info-circle me-2"></i>
                                        Session Details
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row" id="session-details">
                                        <div class="col-md-6 mb-3">
                                            <label class="small fw-bold text-muted">SESSION ID</label>
                                            <div id="session-id-display" class="fw-bold">--</div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="small fw-bold text-muted">SUBJECT</label>
                                            <div id="session-subject-display" class="fw-bold">--</div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="small fw-bold text-muted">SECTION</label>
                                            <div id="session-section-display" class="fw-bold">--</div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="small fw-bold text-muted">CLASS TYPE</label>
                                            <div id="session-type-display" class="fw-bold">--</div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="small fw-bold text-muted">START TIME</label>
                                            <div id="session-start-display" class="fw-bold">--</div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="small fw-bold text-muted">DURATION</label>
                                            <div id="session-duration-display" class="fw-bold">--</div>
                                        </div>
                                        <div class="col-12 mb-3">
                                            <label class="small fw-bold text-muted">JITSI MEETING LINK</label>
                                            <div class="d-flex align-items-center gap-2">
                                                <input type="text" id="session-link-display" class="form-control" readonly>
                                                <button class="btn btn-outline-primary btn-sm" onclick="copyJitsiLink()">
                                                    <i class="bi bi-clipboard"></i>
                                                </button>
                                                <a href="#" id="session-link-open" target="_blank" class="btn btn-outline-success btn-sm">
                                                    <i class="bi bi-box-arrow-up-right"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0">
                                        <i class="bi bi-graph-up me-2"></i>
                                        Live Statistics
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-3 p-3 bg-success bg-opacity-10 rounded">
                                        <div>
                                            <div class="h4 mb-0 text-success" id="live-present-count">0</div>
                                            <small class="text-muted">Present</small>
                                        </div>
                                        <i class="bi bi-check-circle-fill text-success h3 mb-0"></i>
                                    </div>
                                    
                                    <div class="d-flex justify-content-between align-items-center mb-3 p-3 bg-danger bg-opacity-10 rounded">
                                        <div>
                                            <div class="h4 mb-0 text-danger" id="live-absent-count">0</div>
                                            <small class="text-muted">Absent</small>
                                        </div>
                                        <i class="bi bi-x-circle-fill text-danger h3 mb-0"></i>
                                    </div>
                                    
                                    <div class="d-flex justify-content-between align-items-center mb-3 p-3 bg-warning bg-opacity-10 rounded">
                                        <div>
                                            <div class="h4 mb-0 text-warning" id="live-pending-count">0</div>
                                            <small class="text-muted">Pending</small>
                                        </div>
                                        <i class="bi bi-clock-fill text-warning h3 mb-0"></i>
                                    </div>
                                    
                                    <div class="border-top pt-3">
                                        <div class="d-flex justify-content-between">
                                            <span class="fw-bold">Attendance Rate:</span>
                                            <span class="fw-bold text-primary" id="attendance-rate">0%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Session Actions -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0">
                                        <i class="bi bi-tools me-2"></i>
                                        Session Actions
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-3">
                                            <button class="btn btn-warning w-100 btn-lg" onclick="sendSessionPoll()">
                                                <i class="bi bi-lightning-charge-fill me-2"></i>
                                                Send Quick Poll
                                            </button>
                                            <small class="text-muted d-block mt-1">30-second attendance check</small>
                                        </div>
                                        
                                        <div class="col-md-3">
                                            <button class="btn btn-info w-100 btn-lg" onclick="refreshSessionData()">
                                                <i class="bi bi-arrow-clockwise me-2"></i>
                                                Refresh Data
                                            </button>
                                            <small class="text-muted d-block mt-1">Get latest attendance</small>
                                        </div>
                                        
                                        <div class="col-md-3">
                                            <button class="btn btn-success w-100 btn-lg" onclick="exportSessionData()">
                                                <i class="bi bi-download me-2"></i>
                                                Export Data
                                            </button>
                                            <small class="text-muted d-block mt-1">Download as Excel</small>
                                        </div>
                                        
                                        <div class="col-md-3">
                                            <button class="btn btn-danger w-100 btn-lg" onclick="endSession()">
                                                <i class="bi bi-power me-2"></i>
                                                End Session
                                            </button>
                                            <small class="text-muted d-block mt-1">Save & close session</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Activity -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                    <h6 class="card-title mb-0">
                                        <i class="bi bi-clock-history me-2"></i>
                                        Recent Activity
                                    </h6>
                                    <button class="btn btn-outline-primary btn-sm" onclick="refreshActivity()">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                </div>
                                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                                    <div id="recent-activity">
                                        <div class="text-center text-muted py-4">
                                            <i class="bi bi-clock h2"></i>
                                            <p>Loading recent activity...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-lg me-2"></i>Close
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveSessionChanges()">
                        <i class="bi bi-check-lg me-2"></i>Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <style>
        .activity-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-left: 3px solid #e9ecef;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 0 8px 8px 0;
        }
        
        .activity-item.success {
            border-left-color: #198754;
            background: #f0f8f4;
        }
        
        .activity-item.warning {
            border-left-color: #ffc107;
            background: #fffcf0;
        }
        
        .activity-item.info {
            border-left-color: #0dcaf0;
            background: #f0fcff;
        }
        
        .activity-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .activity-content {
            flex-grow: 1;
        }
        
        .activity-time {
            font-size: 12px;
            color: #6c757d;
            white-space: nowrap;
        }
    </style>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Global variables
        let currentSession = null;
        let currentStudents = [];
        const sections = {{ sections | tojson }};

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadSubjects();
            checkActiveSession();
            
            // Auto-refresh every 30 seconds
            setInterval(checkActiveSession, 30000);
        });

        // Toast notification system
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastBody = document.getElementById('toast-body');
            const toastHeader = toast.querySelector('.toast-header');
            
            // Update icon and color based on type
            const icon = toastHeader.querySelector('i');
            icon.className = type === 'success' ? 'bi bi-check-circle me-2 text-success' : 
                           type === 'error' ? 'bi bi-exclamation-circle me-2 text-danger' : 
                           'bi bi-info-circle me-2 text-primary';
            
            toastBody.textContent = message;
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }

        // Load subjects based on section
        function loadSubjects() {
            const sectionSelect = document.getElementById('section_select');
            const subjectSelect = document.getElementById('subject_select');
            
            sectionSelect.addEventListener('change', function() {
                const selectedSection = this.value;
                subjectSelect.innerHTML = '<option value="">Select Subject</option>';
                
                if (selectedSection && sections[selectedSection]) {
                    const subjects = [
                        'Data Structures', 'Python Programming', 'Database Systems',
                        'Machine Learning', 'Web Development', 'Software Engineering',
                        'Computer Networks', 'Operating Systems', 'Mathematics',
                        'Communication Skills', 'Physics', 'Chemistry'
                    ];
                    
                    subjects.forEach(subject => {
                        const option = document.createElement('option');
                        option.value = subject;
                        option.textContent = subject;
                        subjectSelect.appendChild(option);
                    });
                }
            });
        }

        // Create session
        async function createSession() {
            event.preventDefault();
            
            const sectionId = document.getElementById('section_select').value;
            const subject = document.getElementById('subject_select').value;
            const classType = document.getElementById('class_type').value;
            const duration = parseInt(document.getElementById('duration_input').value);
            const jitsiLink = document.getElementById('jitsi_link').value.trim();
            
            // Validation
            if (!sectionId || !subject || !duration || !jitsiLink) {
                showToast('Please fill all required fields', 'error');
                return;
            }
            
            if (!(jitsiLink.includes('meet.jit.si') || jitsiLink.includes('jitsi.'))) {
                showToast('Please enter a valid Jitsi meeting link', 'error');
                return;
            }
            
            const formData = {
                section_id: sectionId,
                subject: subject,
                class_type: classType,
                duration_minutes: duration,
                jitsi_link: jitsiLink
            };

            try {
                showToast('Creating online session...', 'info');
                
                const response = await fetch('/api/online/create_session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('Online session created successfully!', 'success');
                    document.getElementById('sessionForm').reset();
                    loadStudents(sectionId);
                    checkActiveSession();
                } else {
                    showToast(result.message || 'Failed to create session', 'error');
                }
            } catch (error) {
                console.error('Error creating session:', error);
                showToast('Network error: ' + error.message, 'error');
            }
        }

        // Load students for the section - Same as offline system
        async function loadStudents(sectionId) {
            try {
                const response = await fetch(`/api/section_students?section=${sectionId}`);
                const result = await response.json();
                
                if (result.success) {
                    currentStudents = result.students;
                    displayStudents();
                    document.getElementById('students-section').style.display = 'block';
                } else {
                    showToast('Error loading students: ' + result.message, 'error');
                }
            } catch (error) {
                showToast('Error loading students: ' + error.message, 'error');
            }
        }

        // Display students in table - Same design as offline system with proper images
        function displayStudents() {
            const tbody = document.getElementById('students-table-body');
            const totalStudents = document.getElementById('total-students');
            
            totalStudents.textContent = `${currentStudents.length} Students`;
            
            tbody.innerHTML = currentStudents.map((student, index) => {
                // Generate proper image URL from GIET server
                const imageUrl = `https://gietuerp.in/StudentDocuments/${student.rollNo}/${student.rollNo}.JPG`;
                const fallbackInitials = student.name ? student.name.substring(0, 2).toUpperCase() : student.rollNo.substring(0, 2);
                
                return `
                <tr id="student-row-${student.rollNo}">
                    <td class="text-center fw-bold">${index + 1}</td>
                    <td>
                        <div class="student-info">
                            <div class="student-photo-container">
                                <img src="${imageUrl}" 
                                     class="student-photo-img"
                                     alt="${student.name || student.rollNo}"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                                     loading="lazy">
                                <div class="student-photo-fallback" style="display: none;">
                                    ${fallbackInitials}
                                </div>
                            </div>
                            <div class="student-details">
                                <h6>${student.name || student.rollNo}</h6>
                                <p>${student.mobile || 'No mobile'}</p>
                            </div>
                        </div>
                    </td>
                    <td class="fw-bold">${student.rollNo}</td>
                    <td id="response-time-${student.rollNo}" class="text-muted">
                        Not responded yet
                    </td>
                    <td>
                        <button class="status-toggle-btn pending" 
                                id="status-${student.rollNo}"
                                onclick="toggleAttendance('${student.rollNo}')">
                            Pending
                        </button>
                    </td>
                </tr>
            `;
            }).join('');
            
            updateAttendanceSummary();
        }

        // Toggle individual attendance - Same logic as offline system
        function toggleAttendance(rollNo) {
            const btn = document.getElementById(`status-${rollNo}`);
            const responseTimeCell = document.getElementById(`response-time-${rollNo}`);
            
            if (btn.classList.contains('pending')) {
                btn.className = 'status-toggle-btn present';
                btn.textContent = 'Present';
                responseTimeCell.textContent = new Date().toLocaleTimeString();
            } else if (btn.classList.contains('present')) {
                btn.className = 'status-toggle-btn absent';
                btn.textContent = 'Absent';
                responseTimeCell.textContent = 'Marked absent';
            } else {
                btn.className = 'status-toggle-btn pending';
                btn.textContent = 'Pending';
                responseTimeCell.textContent = 'Not responded yet';
            }
            
            updateAttendanceSummary();
        }

        // Mark all present/absent
        function markAllPresent() {
            currentStudents.forEach(student => {
                const btn = document.getElementById(`status-${student.rollNo}`);
                const responseTimeCell = document.getElementById(`response-time-${student.rollNo}`);
                if (btn) {
                    btn.className = 'status-toggle-btn present';
                    btn.textContent = 'Present';
                    responseTimeCell.textContent = new Date().toLocaleTimeString();
                }
            });
            updateAttendanceSummary();
            showToast('All students marked as present', 'success');
        }

        function markAllAbsent() {
            currentStudents.forEach(student => {
                const btn = document.getElementById(`status-${student.rollNo}`);
                const responseTimeCell = document.getElementById(`response-time-${student.rollNo}`);
                if (btn) {
                    btn.className = 'status-toggle-btn absent';
                    btn.textContent = 'Absent';
                    responseTimeCell.textContent = 'Marked absent';
                }
            });
            updateAttendanceSummary();
            showToast('All students marked as absent', 'success');
        }

        // Update attendance summary - Same as offline system
        function updateAttendanceSummary() {
            const presentCount = document.querySelectorAll('.status-toggle-btn.present').length;
            const absentCount = document.querySelectorAll('.status-toggle-btn.absent').length;
            const pendingCount = document.querySelectorAll('.status-toggle-btn.pending').length;
            
            document.getElementById('present-count').textContent = presentCount;
            document.getElementById('absent-count').textContent = absentCount;
            document.getElementById('pending-count').textContent = pendingCount;
        }

        // Check active session status
        async function checkActiveSession() {
            try {
                const response = await fetch('/api/online/active_sessions');
                const result = await response.json();
                
                const statusDiv = document.getElementById('session-status');
                const actionsDiv = document.getElementById('session-actions');
                
                if (result.success && result.sessions.length > 0) {
                    currentSession = result.sessions[0];
                    
                    statusDiv.innerHTML = `
                        <div class="status-indicator active mb-3">
                            <div class="status-dot"></div>
                            Session Active
                        </div>
                        
                        <div class="session-details">
                            <div class="detail-item">
                                <div class="detail-value">${currentSession.subject}</div>
                                <div class="detail-label">Subject</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-value">${currentSession.section_id}</div>
                                <div class="detail-label">Section</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-value">${currentSession.attendance_summary.unique_attendees}</div>
                                <div class="detail-label">Present</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-value">${Math.floor((Date.now() - new Date(currentSession.start_time).getTime()) / 60000)}m</div>
                                <div class="detail-label">Duration</div>
                            </div>
                        </div>
                    `;
                    
                    actionsDiv.style.display = 'flex';
                    
                    if (!document.getElementById('students-section').style.display !== 'none') {
                        loadStudents(currentSession.section_id);
                    }
                    
                    // Start polling for attendance updates
                    startAttendancePolling();
                } else {
                    statusDiv.innerHTML = `
                        <div class="text-center py-5">
                            <div class="status-indicator">
                                <div class="status-dot"></div>
                                No Active Session
                            </div>
                            <p class="mt-3 text-muted">Create a session to start taking online attendance</p>
                        </div>
                    `;
                    actionsDiv.style.display = 'none';
                    document.getElementById('students-section').style.display = 'none';
                }
            } catch (error) {
                console.error('Error checking session status:', error);
            }
        }

        // Send quick poll
        async function sendQuickPoll() {
            if (!currentSession) {
                showToast('No active session found', 'error');
                return;
            }
            
            try {
                showToast('Sending 30-second quick poll...', 'info');
                
                const response = await fetch('/api/online/send_jitsi_popup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSession.session_id,
                        question: 'Are you present in class?',
                        options: ['Present', 'Not Present'],
                        expiry_minutes: 0.5
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('Quick poll sent successfully!', 'success');
                    
                    // Start polling for attendance updates every 5 seconds
                    startAttendancePolling();
                    
                    // Update attendance after 35 seconds
                    setTimeout(() => {
                        updateOnlineAttendance();
                        showToast('Quick poll completed - attendance updated', 'info');
                        stopAttendancePolling();
                    }, 35000);
                } else {
                    showToast('Failed to send quick poll: ' + result.message, 'error');
                }
            } catch (error) {
                showToast('Error sending quick poll: ' + error.message, 'error');
            }
        }


        // Save attendance - Same logic as offline system
        async function saveAttendance() {
            if (!currentSession) {
                showToast('No active session to save', 'error');
                return;
            }
            
            try {
                showToast('Saving attendance data...', 'info');
                
                const response = await fetch('/api/online/save_attendance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: currentSession.session_id })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(result.message, 'success');
                } else {
                    showToast('Failed to save attendance: ' + result.message, 'error');
                }
            } catch (error) {
                showToast('Error saving attendance: ' + error.message, 'error');
            }
        }

        // Manage session - Open comprehensive management modal
        function manageSession() {
            if (!currentSession) {
                showToast('No active session to manage', 'error');
                return;
            }
            
            // Populate session details in modal
            populateSessionModal();
            
            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('sessionManagementModal'));
            modal.show();
            
            // Load recent activity
            loadRecentActivity();
        }
        
        // Populate session management modal with current session data
        function populateSessionModal() {
            if (!currentSession) return;
            
            document.getElementById('session-id-display').textContent = currentSession.session_id || '--';
            document.getElementById('session-subject-display').textContent = currentSession.subject || '--';
            document.getElementById('session-section-display').textContent = currentSession.section_id || '--';
            document.getElementById('session-type-display').textContent = currentSession.class_type || 'lecture';
            
            // Format start time
            if (currentSession.start_time) {
                const startTime = new Date(currentSession.start_time);
                document.getElementById('session-start-display').textContent = startTime.toLocaleString();
            }
            
            // Calculate and show duration
            if (currentSession.start_time) {
                const startTime = new Date(currentSession.start_time);
                const now = new Date();
                const durationMinutes = Math.floor((now - startTime) / (1000 * 60));
                document.getElementById('session-duration-display').textContent = `${durationMinutes} minutes`;
            }
            
            // Set Jitsi link
            const jitsiLink = currentSession.jitsi_link || '';
            document.getElementById('session-link-display').value = jitsiLink;
            document.getElementById('session-link-open').href = jitsiLink;
            
            // Update live statistics
            updateModalStatistics();
        }
        
        // Update statistics in the modal
        function updateModalStatistics() {
            const presentCount = document.querySelectorAll('.status-toggle-btn.present').length;
            const absentCount = document.querySelectorAll('.status-toggle-btn.absent').length;
            const pendingCount = document.querySelectorAll('.status-toggle-btn.pending').length;
            const totalCount = currentStudents.length;
            
            document.getElementById('live-present-count').textContent = presentCount;
            document.getElementById('live-absent-count').textContent = absentCount;
            document.getElementById('live-pending-count').textContent = pendingCount;
            
            const attendanceRate = totalCount > 0 ? Math.round((presentCount / totalCount) * 100) : 0;
            document.getElementById('attendance-rate').textContent = `${attendanceRate}%`;
        }
        
        // Copy Jitsi link to clipboard
        function copyJitsiLink() {
            const linkInput = document.getElementById('session-link-display');
            linkInput.select();
            linkInput.setSelectionRange(0, 99999); // For mobile devices
            
            try {
                document.execCommand('copy');
                showToast('Jitsi link copied to clipboard!', 'success');
            } catch (err) {
                showToast('Failed to copy link', 'error');
            }
        }
        
        // Send poll from session management modal
        async function sendSessionPoll() {
            await sendQuickPoll();
            updateModalStatistics();
        }
        
        // Refresh session data
        async function refreshSessionData() {
            showToast('Refreshing session data...', 'info');
            await updateOnlineAttendance();
            updateModalStatistics();
            showToast('Session data refreshed!', 'success');
        }
        
        // Export session data as Excel
        function exportSessionData() {
            if (!currentSession || !currentStudents.length) {
                showToast('No session data to export', 'error');
                return;
            }
            
            try {
                // Prepare data for export
                const exportData = currentStudents.map((student, index) => {
                    const btn = document.getElementById(`status-${student.rollNo}`);
                    const responseTime = document.getElementById(`response-time-${student.rollNo}`);
                    
                    let status = 'Pending';
                    if (btn) {
                        if (btn.classList.contains('present')) status = 'Present';
                        else if (btn.classList.contains('absent')) status = 'Absent';
                    }
                    
                    return {
                        'S.No': index + 1,
                        'Student Name': student.name || student.rollNo,
                        'Roll Number': student.rollNo,
                        'Mobile': student.mobile || 'N/A',
                        'Status': status,
                        'Response Time': responseTime ? responseTime.textContent : 'Not responded yet'
                    };
                });
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(exportData);
                
                // Add session info as header
                const sessionInfo = [
                    [`Session: ${currentSession.subject}`],
                    [`Section: ${currentSession.section_id}`],
                    [`Date: ${new Date().toLocaleDateString()}`],
                    [`Time: ${new Date().toLocaleTimeString()}`],
                    [''], // Empty row
                ];
                
                // Insert session info at the top
                XLSX.utils.sheet_add_aoa(ws, sessionInfo, { origin: 'A1' });
                XLSX.utils.sheet_add_json(ws, exportData, { origin: 'A7' });
                
                XLSX.utils.book_append_sheet(wb, ws, 'Attendance');
                
                // Generate filename
                const filename = `Attendance_${currentSession.section_id}_${currentSession.subject}_${new Date().toISOString().split('T')[0]}.xlsx`;
                
                // Download file
                XLSX.writeFile(wb, filename);
                
                showToast('Attendance data exported successfully!', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showToast('Failed to export data: ' + error.message, 'error');
            }
        }
        
        // End session with confirmation
        async function endSession() {
            if (!currentSession) {
                showToast('No active session to end', 'error');
                return;
            }
            
            // Show confirmation dialog
            if (!confirm('Are you sure you want to end this session? This will save the attendance data and close the session.')) {
                return;
            }
            
            try {
                showToast('Ending session and saving attendance...', 'info');
                
                // First save attendance
                const saveResponse = await fetch('/api/online/save_attendance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: currentSession.session_id })
                });
                
                const saveResult = await saveResponse.json();
                if (!saveResult.success) {
                    throw new Error(saveResult.message || 'Failed to save attendance');
                }
                
                // Then end the session
                const endResponse = await fetch('/api/online/end_session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: currentSession.session_id })
                });
                
                const endResult = await endResponse.json();
                if (endResult.success) {
                    showToast('Session ended successfully! Attendance has been saved.', 'success');
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('sessionManagementModal'));
                    if (modal) modal.hide();
                    
                    // Reset UI
                    currentSession = null;
                    document.getElementById('students-section').style.display = 'none';
                    checkActiveSession();
                    stopAttendancePolling();
                } else {
                    throw new Error(endResult.message || 'Failed to end session');
                }
            } catch (error) {
                console.error('Error ending session:', error);
                showToast('Error ending session: ' + error.message, 'error');
            }
        }
        
        // Load recent activity for the session
        async function loadRecentActivity() {
            const activityContainer = document.getElementById('recent-activity');
            
            if (!currentSession) {
                activityContainer.innerHTML = '<div class="text-center text-muted py-4"><p>No active session</p></div>';
                return;
            }
            
            try {
                // Simulate loading recent activity (you can replace this with actual API call)
                activityContainer.innerHTML = '<div class="text-center text-muted py-2"><i class="bi bi-arrow-clockwise spin"></i> Loading...</div>';
                
                // Mock activity data (replace with real API call)
                setTimeout(() => {
                    const activities = [
                        {
                            type: 'success',
                            icon: 'bi-check-circle-fill',
                            title: 'Session Started',
                            description: `Started ${currentSession.subject} session for ${currentSession.section_id}`,
                            time: new Date(currentSession.start_time).toLocaleTimeString()
                        },
                        {
                            type: 'info',
                            icon: 'bi-people-fill',
                            title: 'Students Loaded',
                            description: `${currentStudents.length} students loaded for attendance`,
                            time: new Date(Date.now() - 5000).toLocaleTimeString()
                        },
                        {
                            type: 'warning',
                            icon: 'bi-lightning-fill',
                            title: 'Quick Poll Sent',
                            description: 'Attendance popup sent to Jitsi meeting participants',
                            time: new Date(Date.now() - 30000).toLocaleTimeString()
                        }
                    ];
                    
                    if (activities.length === 0) {
                        activityContainer.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-clock h2"></i><p>No recent activity</p></div>';
                    } else {
                        activityContainer.innerHTML = activities.map(activity => `
                            <div class="activity-item ${activity.type}">
                                <div class="activity-icon bg-${activity.type === 'success' ? 'success' : activity.type === 'warning' ? 'warning' : 'info'} text-white">
                                    <i class="${activity.icon}"></i>
                                </div>
                                <div class="activity-content">
                                    <div class="fw-bold">${activity.title}</div>
                                    <div class="small text-muted">${activity.description}</div>
                                </div>
                                <div class="activity-time">
                                    ${activity.time}
                                </div>
                            </div>
                        `).join('');
                    }
                }, 1000);
            } catch (error) {
                activityContainer.innerHTML = '<div class="text-center text-danger py-4"><i class="bi bi-exclamation-triangle"></i><p>Failed to load activity</p></div>';
            }
        }
        
        // Refresh activity feed
        async function refreshActivity() {
            await loadRecentActivity();
            showToast('Activity refreshed!', 'info');
        }
        
        // Save session changes
        function saveSessionChanges() {
            showToast('Session changes saved!', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('sessionManagementModal'));
            if (modal) modal.hide();
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && event.target.tagName !== 'BUTTON') {
                event.preventDefault();
                if (event.target.closest('#sessionForm')) {
                    createSession();
                }
            }
        });
        
        // Attendance polling variables
        let attendancePollingInterval = null;
        
        // Start polling for attendance updates
        function startAttendancePolling() {
            if (attendancePollingInterval) {
                clearInterval(attendancePollingInterval);
            }
            
            // Poll every 3 seconds for real-time updates
            attendancePollingInterval = setInterval(() => {
                updateOnlineAttendance();
            }, 3000);
            
            console.log('Started attendance polling');
        }
        
        // Stop attendance polling
        function stopAttendancePolling() {
            if (attendancePollingInterval) {
                clearInterval(attendancePollingInterval);
                attendancePollingInterval = null;
                console.log('Stopped attendance polling');
            }
        }
        
        // Enhanced updateOnlineAttendance with better error handling
        async function updateOnlineAttendance() {
            if (!currentSession) return;
            
            try {
                const response = await fetch(`/api/online/session_attendance/${currentSession.session_id}`);
                const result = await response.json();
                
                if (result.success && result.attendance && result.attendance.length > 0) {
                    let updatedCount = 0;
                    
                    result.attendance.forEach(record => {
                        const btn = document.getElementById(`status-${record.student_roll}`);
                        const responseTimeCell = document.getElementById(`response-time-${record.student_roll}`);
                        
                        if (btn && record.status === 'present') {
                            // Only update if not already marked as present
                            if (!btn.classList.contains('present')) {
                                btn.className = 'status-toggle-btn present';
                                btn.textContent = 'Present';
                                responseTimeCell.textContent = new Date(record.timestamp).toLocaleTimeString();
                                updatedCount++;
                            }
                        }
                    });
                    
                    // Update summary counts
                    updateAttendanceSummary();
                    
                    // Show notification if students were updated
                    if (updatedCount > 0) {
                        console.log(`Updated ${updatedCount} student(s) attendance status`);
                    }
                }
            } catch (error) {
                console.error('Error updating online attendance:', error);
            }
        }
        
        // Auto-start polling when page loads if there's an active session
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (currentSession) {
                    startAttendancePolling();
                }
            }, 3000); // Wait 3 seconds after page load
        });
        
    </script>
</body>
</html>
